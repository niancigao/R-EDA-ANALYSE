---
title: "TF7_å‡è¨­èˆ‡æ¨¡æ“¬"  
author: "å“é›ç„¶, åœ‹ç«‹ä¸­å±±å¤§å­¸ ç®¡ç†å­¸è¡“ç ”ç©¶ä¸­å¿ƒ"
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
editor_options: 
  chunk_output_type: console
---

<br>

##### è¼‰å…¥è³‡æ–™
```{r echo=T, message=F, cache=F, warning=F}
options(scipen=10)
pacman::p_load(latex2exp,Matrix,dplyr,tidyr,ggplot2,caTools,plotly)
# rm(list=ls(all=TRUE))
load("data/tf4.rdata")
```

<br>

### A.ä½¿ç”¨æ¨¡å‹åšé æ¸¬

+ `B$Buy` : é æœŸå†è³¼æ©Ÿç‡ Re-Purchase Probability
+ `B$Rev` : é æœŸè³¼è²·é‡‘é¡ Expected Revenue Contribution

```{r fig.height=2.4, fig.width=7.2}
par(mfrow=c(1,2), cex=0.8)
hist(B$Buy)
hist(log(B$Rev,10))
```

```{r}
group_by(B,age) %>% 
  summarise(n=n(), Buy=mean(Buy), Rev=mean(Rev)) %>% 
  ggplot(aes(Buy,Rev,size=n,label=age)) + 
  geom_point(alpha=0.5,color='gold') + 
  geom_text(size=4) + 
  labs(title="Age Group Statistics (size: no. customers)") +
  scale_size(range=c(4,20)) + theme_bw()  -> p
ggplotly(p)
```
<br><hr>

### B.å¸¶åƒæ•¸çš„å‡è¨­

##### Â§ Sæ›²ç·š (S-Curve)


ğŸŒ» <z>S-Curve</z> : è¨±å¤šç®¡ç†å·¥å…·éƒ½å‘ˆç¾Så‹çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ 

ğŸŒ» æˆ‘å€‘å¯ä»¥ç”¨Rå…§å»ºçš„é‚è¼¯å¼å‡½æ•¸(`plogis()`)ä¾†æ¨¡æ“¬Sæ›²ç·š
$$\Delta P(x|m,b,a) = m \cdot Logis(\frac{10(x - b)}{a})$$
```{r fig.height=3}
DP = function(x,m0,b0,a0) {m0*plogis((10/a0)*(x-b0))}
par(mar=c(4,4,2,1),cex=0.7)
curve(DP(x,m=0.20,b=30,a=40), 0, 60, lwd=2, ylim=c(0, 0.25),
      main="F( x | m=0.2, b=30, a=40 )", ylab="delta P")
abline(h=seq(0,0.2,0.05),v=seq(0,60,5),col='lightgrey',lty=2)
```

<br>

##### Â§ **å¸¶åƒæ•¸**çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ (Sæ›²ç·š)

ğŸŒ» <z>parameters(åƒæ•¸)</z>å¯ä»¥å¸¶å…¥å½ˆæ€§ï¼Œæ”¾å¯¬æ¨¡æ“¬çš„ç¯„åœ

![](fig/EffectFunition.png)

ğŸŒ» é€éé€™3å€‹<z>parameters(åƒæ•¸)</z>:

+ `m` : æœ€å¤§æ•ˆæœ 
+ `b` : æ•ˆæœçš„ä½ç½®(ä¸Šå‡æ³¢æ®µçš„ä¸­é»)    
+ `a` : æ•ˆæœçš„ç¯„åœ(ä¸Šå‡æ³¢æ®µçš„å¯¬åº¦) 

æˆ‘å€‘å¯ä»¥å¯«ã€ä¸€æ”¯ç¨‹å¼ã€ä¾†æ¨¡æ“¬ã€æ‰€æœ‰å¯èƒ½ã€çš„<z>æˆæœ¬æ•ˆç›Šå‡½æ•¸</z>(Sæ›²ç·š)<br>
è—‰ä»¥æè¿°<z>ç­–ç•¥è®Šæ•¸</z>($x$,æŠ˜åƒ¹å·é¢é¡)å’Œ<z>ç­–ç•¥æ•ˆæœ</z>($\Delta P$,è³¼è²·æ©Ÿç‡å¢å¹…)ä¹‹é–“çš„é—œä¿‚

<br>

##### Â§ ä¼°è¨ˆé æœŸç²åˆ©

æœ‰äº†è¡ŒéŠ·å·¥å…·çš„æˆæœ¬æ•ˆç›Šå‡½æ•¸ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆå°‡é€™å€‹å·¥å…·ç”¨åœ¨æ¯ä¸€ä½é¡§å®¢ä¸Šçš„æ™‚å€™çš„é æœŸæ•ˆç›Š:

$$\hat{R}(x) = \left\{\begin{matrix}
\Delta P \cdot M \cdot margin - x & , & P + \Delta P \leq 1\\ 
(1-P) \cdot M \cdot margin - x & , & else 
\end{matrix}\right.$$

ğŸŒ» çµåˆ  ...

+ é æ¸¬ ($P, M$) : æ¯ä½é¡§å®¢çš„é æœŸè³¼è²·æ©Ÿç‡å’Œè³¼è²·é‡‘é¡ï¼Œèˆ‡
+ å‡è¨­ ($\Delta P(x|m,b,a)$) : è¡ŒéŠ·å·¥å…·å¸¶ä¾†çš„å†è³¼æ©Ÿç‡å¢é¡

æˆ‘å€‘å°±å¯ä»¥ä¼°è¨ˆé€™å€‹å·¥å…·ç”¨åœ¨æ¯ä½é¡§å®¢ä¸Šçš„é æœŸæ•ˆç›Š $\hat{R}(x)$ã€‚ 


ğŸŒ» Note that both $\Delta P$ and $\hat{R}$ are functions of $x$ given $m,b,a$

+ $P, M$ é æœŸè³¼è²·æ©Ÿç‡å’Œé‡‘é¡ï¼Œæ˜¯<z>é æ¸¬</z>
+ $m, b, a$ è¡ŒéŠ·å·¥å…·çš„å±¬æ€§ï¼Œæ˜¯<z>å‡è¨­</z>
+ $x$ è¡ŒéŠ·å¼·åº¦ï¼Œæ˜¯æˆ‘å€‘å¯ä»¥æ“ä½œçš„ã€æƒ³è¦å„ªåŒ–çš„<z>ç­–ç•¥è®Šæ•¸</z>

<br>

**ä¼°è¨ˆæ¯›åˆ©ç‡** $m$
```{r}
# load(data/tf0.rdata)
# group_by(Z0, age) %>% summarise(sum(price)/sum(cost) - 1)
margin = 0.17  # assume margin = 0.17
```

**ä¼°è¨ˆæ¯ä½é¡§å®¢çš„æ·¨æ”¶ç›Š** $\hat{R}(x)$
```{r fig.height=3}
m=0.2; b=25; a=40; x=30
dp = pmin(1-B$Buy, DP(x,m,b,a))   # 1 - p : èª¿æ•´éçš„ï¼Œæ©Ÿç‡ä¸èƒ½è¶…é 1 & delta p 
eR = dp*B$Rev*margin - x
hist(eR,main="é æœŸæ·¨æ”¶ç›Šåˆ†ä½ˆ",xlab="é æœŸæ·¨æ”¶ç›Š",ylab="é¡§å®¢äººæ•¸")
```

<br>

##### Â§ å°çµ„ç·´ç¿’

æ ¹æ“šä»¥ä¸Šçš„åˆ†æçµæœ ...

ğŸš´ æœ‰å¤šå°‘é¡§å®¢çš„é æœŸå ±å„Ÿå¤§æ–¼é›¶ï¼Ÿ (`eR > 0`)?
```{r}
sum(eR>0) # 6679
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°æ‰€æœ‰é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(eR) # -202435
```

ğŸš´ å¦‚æœæˆ‘å€‘é‡å°é æœŸå ±å„Ÿå¤§æ–¼é›¶çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(eR[ eR>0 ]) # 80359
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(eR[ eR>10 ]) # 63812
```

ğŸš´ å¦‚æœæˆ‘å€‘åªé‡å°é æœŸå ±å„Ÿå¤§æ–¼10çš„å—æ¸¯(`z115`)é¡§å®¢åšä¿ƒéŠ·ï¼Œé æœŸå ±å„Ÿå°‡æ˜¯ï¼Ÿ
```{r}
sum(eR[ eR>10 & B$area=="z115"   ]) # 12532

```


<br><hr>



### C.å¸‚å ´æ¨¡æ“¬

##### Â§ ä¸€å€‹è¡ŒéŠ·å·¥å…·

çµ¦å®šå·¥å…·åƒæ•¸($m,b,a$)ï¼Œæˆ‘å€‘å¯åœ¨å…¶æœ‰æ•ˆæˆæœ¬ç¯„åœ($x \in [b-\frac{a}{2}, b+\frac{a}{2}]$)ä¹‹å…§ï¼Œä¼°è¨ˆå·¥å…·çš„æ•ˆæœï¼š

+ `eReturn` : å°æ‰€æœ‰çš„äººè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š
+ `N` : é æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººæ•¸
+ `eReturn2` : åªå°æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººåšè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š

å¦‚ä½•éš¨æˆæœ¬è®ŠåŒ–ã€‚

```{r}
m=0.2; b=25; a=40; X = seq(10,45,1)

df = sapply(X, function(x) {
  dp = pmin(DP(x,m,b,a),1-B$Buy)
  eR = dp*B$Rev*margin - x
  c(x=x, eReturn=sum(eR), N=sum(eR > 0), eReturn2=sum(eR[eR > 0]))
  }) %>% t %>% data.frame  

df %>% gather('key','value',-x) %>% 
  ggplot(aes(x=x, y=value, col=key)) + 
  geom_hline(yintercept=0,linetype='dashed') +
  geom_line(size=1.5,alpha=0.5) + 
  facet_wrap(~key,ncol=1,scales='free_y') + theme_bw()

# gather : ä»¥ x ç‚ºä¸»ï¼Œè½‰ df è¡¨æ ¼
# scales='free_y' : æ ¹æ“šæ¯å€‹é¢æ¿ä¸­çš„æ•¸æ“šä¾†ç¸®æ”¾ y è»¸ç¯„åœ

# gather()
# ç¬¬ä¸€ä¸ªå‚æ•°æ”¾çš„æ˜¯åŸæ•°æ®ï¼Œæ•°æ®ç±»å‹è¦æ˜¯ä¸€ä¸ªæ•°æ®æ¡†
# ä¸‹é¢ä¼ ä¸€ä¸ªé”®å€¼å¯¹ï¼Œåå­—æ˜¯è‡ªå·±èµ·çš„ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯åšæ–°è½¬æ¢æˆçš„äºŒç»´è¡¨çš„è¡¨å¤´ï¼Œå³ä¸¤ä¸ªå˜é‡å
# ç¬¬å››ä¸ªæ˜¯é€‰ä¸­è¦è½¬ç½®çš„åˆ—ï¼Œè¿™ä¸ªå‚æ•°ä¸å†™çš„è¯å°±é»˜è®¤å…¨éƒ¨è½¬ç½®
# åé¢è¿˜å¯ä»¥åŠ å¯é€‰å‚æ•° na.rmï¼Œå¦‚æœna.rm = TRUEï¼Œé‚£ä¹ˆå°†ä¼šåœ¨æ–°è¡¨ä¸­å»é™¤åŸè¡¨ä¸­çš„ç¼ºå¤±å€¼(NA)

# https://blog.csdn.net/six66667/article/details/84888644
# ç»“æœ:è¡Œåˆ—è½¬æ¢è¿‡æ¥äº†ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŸæ•°æ®stuï¼ŒäºŒã€ä¸‰ä¸¤ä¸ªå‚æ•°æ˜¯é”®å€¼å¯¹ï¼ˆæ€§åˆ«ï¼Œäººæ•°ï¼‰ï¼Œç¬¬å››ä¸ªè¡¨ç¤ºå‡å»ï¼ˆé™¤å»gradeåˆ—ï¼Œå°±åªè½¬ç½®å‰©ä¸‹ä¸¤åˆ—ï¼‰

```

##### Â§ å¤šå€‹è¡ŒéŠ·å·¥å…·

With some modification (ä¿®æ”¹) of the code, we can define multiple (4) instruments (å·¥å…·)

```{r fig.height=3, fig.width=7}
# å…ˆä¾†å¼µ 4 å€‹æ¨¡å‹çš„ S æ›²ç·š

mm=c(0.20, 0.25, 0.15, 0.25)
bb=c(  25,   30,   15,   30)
aa=c(  40,   40,   30,   60) 

X = seq(0,60,2) 
do.call(rbind, lapply(1:length(mm), function(i) data.frame(
  Inst=paste0('Inst',i), Cost=X, 
  Gain=DP(X,mm[i],bb[i],aa[i])
  ))) %>% data.frame %>% 
  ggplot(aes(x=Cost, y=Gain, col=Inst)) +
  geom_line(size=1.5,alpha=0.5) + theme_bw() +
  ggtitle("Prob. Function: f(x|m,b,a)")

```

and run simulation (æ¨¡æ“¬) on multiple instrument to compare their cost effectiveness (æ•ˆç›Š). 

```{r warning=F, fig.height=8, fig.width=8}

X = seq(10, 60, 1)  # æˆæœ¬ç¯„åœ

# é€™è£¡æœ‰ 4 å€‹æ¨¡æ“¬å™¨ï¼Œåˆ†åˆ¥çœ‹
# eReturn : å°æ‰€æœ‰çš„äººè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š
# eReturn2 : åªå°æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººåšè¡ŒéŠ·çš„ç¸½é æœŸæ”¶ç›Š
# N : é æœŸæ”¶ç›Šå¤§æ–¼é›¶çš„äººæ•¸
# å†ç”¨ lapply rbind 4 å€‹æ¨¡æ“¬å™¨

df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    dp = pmin(1-B$Buy, DP(x,mm[i],bb[i],aa[i]))
    eR = dp*B$Rev*margin - x
    c(i=i, x=x, eR.ALL=sum(eR), N=sum(eR>0), eR.SEL=sum(eR[eR > 0]) )
    }) %>% t %>% data.frame
  })) 

# vars :é¸æ“‡è®Šé‡ == select()

df %>% 
  mutate_at(vars(eR.ALL, eR.SEL), function(y) round(y/1000)) %>% 
  gather('key','value',-i,-x) %>% 
  mutate(Instrument = paste0('I',i)) %>%
  ggplot(aes(x=x, y=value, col=Instrument)) + 
  geom_hline(yintercept=0, linetype='dashed', col='blue') +
  geom_line(size=1.5,alpha=0.5) + 
  xlab('å·¥å…·é¸é …(æˆæœ¬)') + ylab('é æœŸæ”¶ç›Š($K)') + 
  ggtitle('è¡ŒéŠ·å·¥å…·å„ªåŒ–','å‡è¨­è¡ŒéŠ·å·¥å…·çš„æ•ˆæœæ˜¯å…¶æˆæœ¬çš„å‡½æ•¸') +
    facet_wrap(~key,ncol=1,scales='free_y') + theme_bw() -> p

plotly::ggplotly(p)

# eR.ALL=sum(eR)ï¼Œå…¨åšé€šå¸¸éƒ½æœƒè™§æœ¬
# eR.SEL : æŒ‘æ­£çš„åš : I2ï¼Œé æœŸæ·¨æ”¶ç›Šæœ€å¤§ï¼Œè½åœ¨æˆæœ¬ 40 è™•
# é æœŸ(æ·¨)ç‡Ÿæ”¶ : 147 K (146568) 
# N : 40å…ƒæ™‚ï¼Œå¯å° 8344 å€‹äººåš

```

```{r}

# åˆ©ç”¨é€™è¡ŒæŒ‡ä»¤ï¼ŒæŠ“å‡ºæ‰€æœ‰æ¨¡æ“¬å™¨çš„æœ€ä½³è§£ : eR.SEL æœ€å¤§ (æŒ‘æ­£çš„åš)
group_by(df, i) %>% top_n(1,eR.SEL)
```

ğŸš´ å¾æ¨¡æ“¬çš„çµæœæˆ‘å€‘å¯ä»¥å¾ˆå®¹æ˜“çœ‹å‡ºæ¯ä¸€å€‹å·¥å…·çš„ï¼š

+ æœ€ä½³è¡ŒéŠ·å¼·åº¦
+ æœ€ä½³è¡ŒéŠ·å°è±¡äººæ•¸
+ æœ€ä½³é æœŸç²åˆ©

<br><hr>


### D.è¨è«–
å…ˆçœ‹ä¸€ä¸‹å•Šæ¯ä¸€å€‹å¹´é½¡æ—ç¾¤çš„é¡§å®¢äººæ•¸ ...
```{r fig.height=1.5, fig.width=5}
par(cex=0.7, mar=c(2,2,1,2))
table(B$age) %>% barplot
```
<br>

<p class="qiz">
<span style="font-size:18px"> ğŸš´ è¨è«–ï¼š</span><br>
å¦‚æœä¸Šè¿°4çµ„å·¥å…·åƒæ•¸åˆ†åˆ¥æ˜¯æŸæŠ˜åƒ¹åˆ¸å°4å€‹ä¸åŒå¹´é½¡æ—ç¾¤çš„æ•ˆæœï¼š<br>
&emsp; â–   I1 : a24, a29 <br>
&emsp; â–   I2 : a34, a39 <br>
&emsp; â–   I3 : a44, a49 <br>
&emsp; â–   I4 : a54, a59, a64, a69 <br>
å¦‚æœä½ å¯ä»¥åœ¨é€™4å€‹å¹´é½¡æ—ç¾¤ä¹‹ä¸­é¸æ“‡è¡ŒéŠ·å°è±¡ï¼Œä½ æ‡‰è©²å¦‚ä½•ï¼š<br>
&emsp; â–  é¸æ“‡è¡ŒéŠ·å°è±¡(`N`)ï¼Ÿ<br>
&emsp; â–  è¨­å®šæŠ˜åƒ¹åˆ¸çš„é¢é¡(`x`)ï¼Ÿ<br>
&emsp; â–  ä¼°è¨ˆé æœŸå ±å„Ÿ(`eR.SEL`)ï¼Ÿ<br>
&emsp; â–  I1 :é¢é¡:34ï¼›å°560äººåšï¼›é æœŸå ±å„Ÿ:6472<br>
&emsp; â–  I2 :é¢é¡:40ï¼›å°4083äººåšï¼›é æœŸå ±å„Ÿ:74282<br>
&emsp; â–  I3 :é¢é¡:22ï¼›å°3131äººåšï¼›é æœŸå ±å„Ÿ:34746<br>
&emsp; â–  I4 :é¢é¡:43ï¼›å°643äººåšï¼›é æœŸå ±å„Ÿ:9403
</p class="qiz"><br>

<br>

```{r}

# åˆ†åˆ¥æŒ‘å‡º4å€‹ä¸åŒå¹´é½¡æ—ç¾¤
ci = sapply(
  list(c("a24","a29"),c("a34","a39"),
       c("a44","a49"),c("a54","a59","a64","a69")), 
  function(v) B$age %in% v)  

X = seq(10, 60, 1) 
df = do.call(rbind, lapply(1:length(mm), function(i) {
  sapply(X, function(x) {
    dp = pmin(1- B$Buy[ ci[,i] ]  , DP(x,mm[i],bb[i],aa[i]))
    eR = dp* B$Rev[ ci[,i] ]  *margin - x
    c(i=i, x=x, eR.ALL=sum(eR), N=sum(eR>0), eR.SEL=sum(eR[eR > 0]) )
    }) %>% t %>% data.frame
  })) 

group_by(df, i) %>% top_n(1,eR.SEL)

```

<br><br><hr>
