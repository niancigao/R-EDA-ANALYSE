---
title: æ¢ç‹€åœ– (Bar Plots) 
author: Tony Chuo, NSYSU
date: "`r Sys.time()`"
output: 
  html_document: 
    theme: spacelab
    highlight: pygments
    css: ../etc/style.css
---

```{r echo=F, results='hide', message=FALSE, warning=FALSE}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE) 
options(scipen=20, digits=4, width=80, tibble.print_min=4)
# rmarkdown::find_pandoc(version = '2.7.3')
```

<br><br><p class="wwl"><span style='font-size:24px'> ğŸ  </span>
<span style='font-size:18px;'>
<b>å­¸ç¿’é‡é»ï¼š</b></span><br>
&emsp; â–  æ¢ç‹€åœ–ç°¡å–®æ˜“æ‡‚ï¼Œæ˜¯å¾ˆé‡è¦çš„çš„åˆ†æã€æºé€šå·¥å…·<br>
&emsp; â–  é»ç‹€åœ–é€šå¸¸ç”¨åœ¨æ¯”è¼ƒå„åˆ†æå°è±¡<br>
&emsp; â–  æ¢ç‹€åœ–ä¸»è¦ç”¨åœ¨åˆ†é¡æ¯”è¼ƒ<br>
&emsp; â–   `ggplot`çš„ä¸‰ç¨®æ¢ç‹€åœ–<br>
&emsp; &emsp; â—‡ `geom_bar()` : é¡ä¼¼ `barplot()` <br>
&emsp; &emsp; â—‡ `geom_col()` : é¡ä¼¼ `table() %>% barplot()` <br>
&emsp; &emsp; â—‡ `geom_histogram()` : `hist()` <br>
&emsp; â–  æœ‰å…©å€‹åˆ†é¡è®Šæ•¸æ™‚ï¼Œéœ€è¦è¨­å®š`position`ä¾†é¸æ“‡æ¯”è¼ƒçš„åŸºç¤<br>
&emsp; &emsp; `"stack"` : æ¯”è¼ƒå¤§é¡ç¸½æ•¸(å †ç–Š) <br>
&emsp; &emsp; `"dodge"` : æ¯”è¼ƒå„ç´°é¡æ•¸é‡(èº²é¿ã€é–ƒé–‹) <br>
&emsp; &emsp; `"fill"` :  æ¯”è¼ƒç´°é¡æ¯”ç‡(å¡—è‰²)<br>
</p class="wwl"><br>

<br>


### 1. ä¸‰ç¨®ä¸ä¸€æ¨£çš„æ¢ç‹€åœ–

##### 1.1 æº–å‚™è³‡æ–™

è¼‰å…¥ librariesï¼Œä¸¦é è¨­ç¹ªåœ–åƒæ•¸
```{r message=FALSE, warning=FALSE}
pacman::p_load(dplyr,ggplot2,plotly,gridExtra)
theme_set(theme_get() + theme(
  text=element_text(size=8), legend.key.size=unit(10,"points")
  ))
```

è¼‰å…¥ comics è³‡æ–™é›†
```{r message=FALSE, warning=FALSE}
D = read.csv("data/comics1.csv",stringsAsFactors=F) %>% as_tibble
glimpse(D)
```
`tibble` åœ¨ `dplyr` ä¸­ï¼Œè¢«å®šç¾©ç‚ºå¢å¼·å‹çš„è³‡æ–™æ¡†ã€‚


##### 1.2 ä¸‰ç¨®æ¢ç‹€åœ–

ğŸŒ» `ggplot`ä¹‹ä¸­ï¼Œæœ‰ä¸‰ç¨®æ¢ç‹€åœ–å¯ä»¥ä½¿ç”¨

+ **geom_histogram** é¡¯ç¤ºé€£çºŒè®Šæ•¸çš„ <i>åˆ†å¸ƒ</i>ã€‚
+ **geom_bar** é¡¯ç¤ºé›¢æ•£è®Šæ•¸ çš„<i>è¨ˆæ•¸</i> (<i>åˆ†å¸ƒ</i>)
+ **geom_col** é¡¯ç¤º / æ¯”è¼ƒ ä¸åŒé¡åˆ¥é–“çš„çµ±è¨ˆæ•¸æ“šã€‚

```{r fig.height=2, fig.width=6.5}
g1 = ggplot(D, aes(x=year)) + geom_histogram(binwidth=10)
g2 = ggplot(D, aes(x=align)) + geom_bar()
g3 = group_by(D, sex) %>% 
  summarise( casualty.ratio = mean(alive=="Deceased") ) %>%
  ggplot(aes(x=sex, y=casualty.ratio)) + geom_col()
grid.arrange(g1,g2,g3,nrow=1)  # align three plots in a row 

#geom_col() è¦è‡ªå·±ç®—(é¸)Yï¼Œå…¶ä»–çš„æœƒè‡ªå‹•ç®—æˆæ•¸é‡
```

ğŸŒ» é€™äº›æ¢ç‹€åœ–æœ‰åŠ©æ–¼æˆ‘å€‘åš<z>åˆ†é¡æ¯”è¼ƒ</z>

+ å¹¾åå¹´ä¾†ï¼Œæ–°è§’è‰²çš„æ•¸é‡
+ å¥½äººã€å£äººï¼Œä»¥åŠä¸­ç«‹è§’è‰²çš„æ•¸é‡
+ ç”·æ€§è§’è‰²å’Œå¥³æ€§è§’è‰²å¹³å‡çš„å‚·äº¡ç‡

<br><br>


### 2. å…©é¡åˆ¥ã€å¤§é¡èˆ‡ç´°é¡æ¯”è¼ƒ

åªè¦åœ¨`aes()`ä¹‹ä¸­å°‡`fill`å±¬æ€§å°æ‡‰åˆ°ç´°é¡è®Šæ•¸ï¼Œ
æˆ‘å€‘å°±å¯ä»¥åœ¨æ¢ç‹€åœ–çš„å¤§é¡ä¹‹ä¸­ï¼Œä»¥é¡è‰²å€åˆ†ç´°é¡ã€‚

```{r fig.height=2, fig.width=6}
g1 = ggplot(D, aes(x=year, fill=publisher)) + geom_histogram(binwidth=10)
g2 = ggplot(D, aes(x=align, fill=sex)) + geom_bar()
grid.arrange(g1,g2,nrow=1)  # align three plots in a row 
```

<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>ğŸš´ **EXERCISE :**</u></b></span>


è«‹è©¦è‘—ä¿®æ”¹ä»¥ä¸‹ç¨‹å¼ç¢¼ä¾†è£½ä½œä¸‹é¢çš„åœ–è¡¨ã€‚

```{r  fig.height=2, fig.width=3}
# group_by(D, sex) %>% 
#  summarise( casualty.ratio = mean(alive=="Deceased") ) %>%
#  ggplot(aes(x=sex, y=casualty.ratio)) + geom_col()
```

```{r  fig.height=2, fig.width=3}
group_by(D, sex, align) %>% 
  summarise(casualty=mean(alive=="Deceased"), .groups="drop") %>%
  ggplot(aes(x=sex, y=casualty, fill=align)) + geom_col()
```
<br>
```{r  fig.height=2, fig.width=3}
group_by(D, sex, align) %>% 
  summarise(casualty=mean(alive=="Deceased")) %>%
  ggplot(aes(x=sex, y=casualty, fill=align)) + geom_col()
```
<br>

<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>â“ **QUIZ :**</u></b></span>

æ ¹æ“šä»¥ä¸Šåœ–è¡¨

  + ä½ çŸ¥é“å“ªå€‹æ€§åˆ¥æœ‰è¼ƒå¤šçš„ã€Œå¥½äººã€è§’è‰²å—ï¼Ÿ
  + ã€Œç”·æ€§ä¸­ç«‹è§’è‰²è¦æ¯”å¥³æ€§ä¸­ç«‹è§’è‰²ä¾†å¾—å¤šã€ï¼Œé€™å¥è©±æ˜¯å…¬å¹³çš„å—ï¼Ÿ


<br><br>

### 3. æ¯”è¼ƒçš„åŸºç¤

##### 3.1 åˆ—è¯è¡¨ (Contingency Table)

é¡åˆ¥é–“çš„æ¯”è¼ƒæ˜¯åŸºæ–¼ä¸€ç¨®åç‚º <z>åˆ—è¯è¡¨</z> çš„è³‡æ–™çµæ§‹ã€‚

```{r}
table(D$align, D$sex)
```

<br>

##### 3.2 åˆ—è¯è¡¨çš„é•·å‹è³‡æ–™æ ¼å¼

ç„¶è€Œï¼Œ`ggplot` ä¸¦ä¸æ¡ç”¨è¡¨æ ¼å‹å¼ã€‚
ç‚ºäº†å’Œ `aes()` é€™ä¸€é…å°ç¹ªåœ–ç›¸å®¹ï¼Œ
æˆ‘å€‘éœ€è¦æº–å‚™ <z>é•·å‹è³‡æ–™æ ¼å¼</z> çš„æ•¸æ“šã€‚

åœ¨è£½ä½œé•·å‹è³‡æ–™æ ¼å¼æ™‚ï¼Œ`count()` æ¯” `group_by() %>% summarise()` æ›´å®¹æ˜“æ“ä½œã€‚
```{r}
count(D, align, sex)
```

<br>

##### 3.3 è¨­ç½® `position` ä¾†æ”¹è®Šæ¯”è¼ƒçš„åŸºç¤

é€éåœ¨ geom_col() ä¸­è¨­ç½® `position` é€™ä¸€åƒæ•¸ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ä¸åŒæ–¹å¼æ’åˆ—å’Œæ¯”è¼ƒè¡¨æ ¼ä¸­çš„æ•¸æ“šã€‚

```{r fig.height=1.8, fig.width=7}
dx = count(D, align, sex)
gg = lapply(c("stack","dodge","fill"), function(pos) {
  ggplot(dx, aes(sex,n,fill=align)) + 
    geom_col(position=pos, alpha=0.6) + labs(title=pos,y="")
  }) 
grid.arrange(grobs=gg, nrow=1)
```

ğŸŒ» ä¸åŒçš„åœ–è¡¨æœ‰ä¸åŒçš„ç”¨é€”...

+ `stack` è©²æ•¸æ“šå¼·èª¿æ€§åˆ¥çš„ç¸½åˆ
+ `dodge` æ¯”è¼ƒè¡¨æ ¼ä¸­æ‰€æœ‰çš„æ•¸æ“š
+ `fill` å°‡æ•¸æ“šè½‰æ›ç‚ºæ¯”ä¾‹ï¼Œä»¥é€²è¡Œç›¸å°æ€§çš„æ¯”è¼ƒ

<br>

<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>â“ **QUIZ :**</u></b></span><br>
ä¸Šè¿°ä¸‰å€‹åœ–è¡¨ä¸­ï¼Œå“ªå€‹æ¯”è¼ƒå®¹æ˜“...

+ ä¾ç…§æ€§åˆ¥åˆ†é¡ï¼Œæ¯”è¼ƒã€Œä¸­ç«‹ã€è§’è‰²çš„æ•¸é‡
+ ä¾ç…§æ€§åˆ¥åˆ†é¡ï¼Œæ¯”è¼ƒã€Œä¸­ç«‹ã€è§’è‰²çš„æ¯”ä¾‹
+ æ¯”è¼ƒå„æ€§åˆ¥çš„ç¸½äººæ•¸

<br>

<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>ğŸš´ **EXERCISE :**</u></b></span><br>
äº‹å¯¦ä¸Šï¼Œæˆ‘å€‘å¯ä»¥ç”¨å®Œå…¨ç›¸åŒçš„æ•¸æ“šå†ç¹ªè£½ä¸‰å€‹åœ–è¡¨ã€‚
è«‹è©¦è‘—ä¿®æ”¹ä»¥ä¸‹ç¨‹å¼ç¢¼ä¾†è£½ä½œä¸‹é¢çš„åœ–è¡¨ã€‚

```{r fig.height=1.8, fig.width=7}
# gg = lapply(c("stack","dodge","fill"), function(pos) {
#   ggplot(dx, aes(sex,n,fill=align)) + 
#     geom_col(position=pos, alpha=0.6) + labs(title=pos,y="")
#   }) 
# grid.arrange(grobs=gg, nrow=1)
```

```{r  fig.height=1.8, fig.width=7}
gg = lapply(c("stack","dodge","fill"), function(pos) {
  ggplot(dx, aes(align,n,fill=sex)) + 
    geom_col(position=pos, alpha=0.6) + labs(title=pos,y="")
  })
grid.arrange(grobs=gg, nrow=1)
```
<br><br>

### 4. æ¢å½¢åœ–çš„åˆ†æèƒ½åŠ›

è®“æˆ‘å€‘åœ¨ `D` è³‡æ–™é›†ä¸­ï¼Œæ–°å¢ä¸€å€‹åç‚º `decade` çš„æ¬„ä½ã€‚
```{r}
D = mutate(D, decade = (D$year -1900) %/% 10)
table(D$decade)
```

##### 4.1 çª—æ ¼åŠŸèƒ½ `facet`

å¥½å£äººçš„æ•¸é‡å¦‚ä½•éš¨å¹´ä»£è€Œè®Š â“ 
å¥½å£äººæ•¸é‡çš„è®ŠåŒ–è¶¨å‹¢æ˜¯å¦å› æ€§åˆ¥ã€å‡ºç‰ˆå•†è€Œç•° â“ 

`facet_grid(var1~var2)`å¯ä»¥å°±æ¯ä¸€ç¨®(`v1`,`v2`)çš„çµ„åˆç•«ä¸€å€‹çª—æ ¼     
```{r fig.height=3, fig.width=6}
ggplot(D, aes(x=decade, fill=align)) + 
  geom_bar() + facet_grid(sex~publisher)  
```

æˆ‘å€‘ç”¨å…©è¡Œç°¡å–®çš„ç¨‹å¼ç¢¼å°±å¯ä»¥å›ç­”é€™äº›çœ‹ä¼¼è¤‡é›œç¹ç‘£çš„å•é¡Œäº†ï¼

é€šå¸¸ï¼Œæ¯”ä¾‹æœƒæ¯”æ•¸é‡æ›´èƒ½åæ˜ å‡ºè¶¨å‹¢ï¼Œæ¬²æŠŠæ•¸å­—è½‰æ›ç‚ºæ¯”ä¾‹ï¼Œ
æˆ‘å€‘åªéœ€è¦å°‡ `position='fill` æ”¾åœ¨ `geom_bar()` ä¸­ã€‚
```{r fig.height=3, fig.width=6}
# here we convert `align` into a factor so we can 
# re-order the align levels in a desirable way
D2 = D %>% mutate(
  align=factor(align,levels=c("Bad","Neutral","Good"))
  ) %>% 
  filter(decade >= 6) 
ggplot(D2, aes(x=decade, fill=align)) + 
  geom_bar(position="fill") +   
  facet_grid(sex~publisher)
```


##### 4.2 æ¯”ä¾‹ vs. æ•¸é‡

ä¸‹é¢æ˜¯ä¸€å€‹æ¢å½¢åœ–ï¼Œé¡¯ç¤ºäº†åœ¨ä¸åŒé ­é«®é¡è‰²å’Œä¸åŒçœ¼ç›é¡è‰²çš„æ­é…ä¸­ï¼Œå¥½äººå’Œå£äººæ‰€ä½”çš„æ¯”ä¾‹ã€‚
```{r fig.height=4, fig.width=6}
hx = count(D2, hair, sort=T)
ex = count(D2, eye, sort=T)
D2 %>% filter(
  hair%in%hx$hair[1:3], eye%in%ex$eye[1:3], 
  align!="Neutral") %>% 
  ggplot(aes(decade,fill=align)) + 
  geom_bar(position="fill",alpha=0.7) +
  labs(x="eye",y="hair") +
  facet_grid(hair~eye)
```

<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>ğŸš´ **EXERCISE :**</u></b></span><br>
ä½ å¯ä»¥è©¦è‘—ä¿®æ”¹ä¸Šé¢çš„ç¨‹å¼ç¢¼

+ ç¹ªè£½**æ•¸å­—**è€Œä¸æ˜¯**æ¯”ç‡**å—ï¼Ÿ
+ ä½ ç™¼ç¾äº†ä»€éº¼å‘¢ï¼Ÿ
+ åœ¨é€™å€‹ exercise ä¸­ï¼Œä½ å­¸åˆ°äº†ä»€éº¼å‘¢ï¼Ÿ

<br><br>




