---
title: UNIT12B2ï¼šé¡åˆ¥æ¨¡å‹ã€é æ¸¬æ©Ÿç‡èˆ‡å•†æ¥­æ±ºç­– 
subtitle: é æ¸¬èˆ‡æ±ºç­–
author: ä¸­å±±å¤§å­¸ç®¡ç†å­¸é™¢ å“é›ç„¶
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---

```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# Formating Codes.  Do not change the codes in this chunk !!
# rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8)
options(scipen=20, digits=5, width=80)
if(!require(pacman)) install.packages("pacman")
```
<hr>

```{r results='hide', message=FALSE, warning=FALSE}
pacman::p_load(caTools, ggplot2, dplyr)
D = read.csv("data/quality.csv")  # Read in dataset

set.seed(88)
split = sample.split(D$PoorCare, SplitRatio = 0.75)  # split vector
TR = subset(D, split == TRUE)
TS = subset(D, split == FALSE)
glm1 = glm(PoorCare ~ OfficeVisits + Narcotics, TR, family=binomial)
summary(glm1)

```
<br><hr>

### ã€Aã€‘å¾é æ¸¬åˆ°æ±ºç­–

![Fig 12.3 - å¾é æ¸¬åˆ°æ±ºç­–](fig/Fig12.3.JPG)

<br><hr>

### ã€Bã€‘é æ¸¬æ©Ÿç‡åˆ†ä½ˆ (DPP)
å› ç‚ºé€™å€‹è³‡æ–™é›†å¾ˆå°ï¼Œæˆ‘å€‘ä½¿ç”¨å…¨éƒ¨çš„è³‡æ–™ä¾†åšæ¨¡æ“¬ (é€šå¸¸æˆ‘å€‘æ˜¯ä½¿ç”¨æ¸¬è©¦è³‡æ–™é›†)
```{r fig.height=3.2, fig.width=7}
pred = predict(glm1, D, type="response")
y = D$PoorCare
data.frame(pred, y) %>% 
  ggplot(aes(x=pred, fill=factor(y))) + 
  geom_histogram(bins=20, col='white', position="stack", alpha=0.5) +
  ggtitle("Distribution of Predicted Probability (DPP,FULL)") +
  xlab("predicted probability")
```
<br><hr>

### ã€Cã€‘è©¦ç®—æœŸæœ›å ±é…¬

**å ±é…¬çŸ©é™£ Payoff Matrix**

+ TN: NoAction, GoodCare; æ²’äº‹ (0)
+ FN: NoAction, PoorCare; é¢¨éšªæˆæœ¬å¾ˆé«˜ï¼ŒPoorCareï¼Œä¸çµ¦åƒè—¥ (-100) 
+ FP: Action, GoodCare;   é é˜²æˆæœ¬ï¼ŒGoodCareï¼Œçµ¦åƒè—¥ï¼Œæµªè²»è—¥çš„æˆæœ¬ï¼Œé¢¨æ§çš„æˆæœ¬ (-10)
+ TP: Action, PoorCare;   é é˜²æˆæœ¬ + é™ä½å¾Œçš„é¢¨éšªæˆæœ¬ (åƒè—¥åªèƒ½é™ä½)ï¼Œ(-100+50-10)

```{r}

# æ··æ·†çŸ©é™£(æ©Ÿç‡) * å ±é…¬çŸ©é™£ï¼Œç•«æˆç·šï¼Œæœ€é«˜é‚£é»å°±æ˜¯æœ€ä½³æœŸæœ›å ±é…¬äº†
# å‡è¨­ã€ä¼°è¨ˆå ±é…¬çŸ©é™£

payoff = matrix(c(0,-100,-10,-50),2,2)     # é é˜²æˆæœ¬(+60) + é™ä½å¾Œçš„é¢¨éšªæˆæœ¬(-10)
rownames(payoff) = c("FALSE","TRUE")       # çœŸå¯¦ç‹€æ³
colnames(payoff) = c("NoAct","Act")        # æ˜¯å¦è¡Œå‹•
payoff

```

**æœŸæœ›å ±é…¬ Expected Payoff**
```{r fig.height=3.2, fig.width=7}

cutoff = seq(0, 1, 0.01)                                       # æ¯0.01ç•«ä¸€é»ï¼Œæ©Ÿç‡

result = sapply(cutoff, function(p) {
  cm = table(factor(y == 1, c(F,T)), factor(pred > p, c(F,T))) # æ¯å€‹é–¾å€¼ä¸‹çš„æ··æ·†çŸ©é™£
  sum(cm * payoff)     ### sum of confusion * payoff matrix
  })

# æ··æ·†çŸ©é™£ table(factor(...))
# ç”¨factorè®Šæˆé¡åˆ¥ï¼Œç¢ºä¿ä¸€å®šæœ‰0ã€1æ¬„ä½ï¼Œå€‹æ•¸0å€‹ä¹Ÿç„¡å¦¨ï¼Œ2*2è·é™£
# (æ•¸å€¼çš„è©±ï¼Œå¦‚æœæœ‰ä¸€æ’å…¨ç‚º0ï¼ŒçŸ©é™£å¯èƒ½å¾2*2è®Šæˆ1*2...ï¼Œæœƒç„¡æ³•å°é½Šå ±é…¬çŸ©é™£&ç›¸ä¹˜)

i = which.max(result)                                          # å–æœ€å¤§çš„index

par(cex=0.7, mar=c(4,4,3,1))

plot(cutoff, result, type='l', col='cyan', lwd=2,
     main=sprintf("Optomal Expected Result: $%d @ %.2f",result[i],cutoff[i]))
abline(v=seq(0,1,0.1),h=seq(-6000,0,100),col='lightgray',lty=3)
points(cutoff[i], result[i], pch=20, col='red', cex=2)         # iï¼Œæœ€ä½³æœŸæœ›å ±é…¬çš„é»

```
<br><hr>


ğŸŒ· å› ç‚ºè³‡æ–™é»(131ç­†)å¤ªå°‘ï¼Œä»¥ä¸Šæ¨¡æ“¬çš„æ›²ç·šå¾ˆä¸å¹³æ•´ï¼Œä»¥ä¸‹æˆ‘å€‘å°‡è³‡æ–™é»æ•¸æ“´å¤§ç‚º10K

```{r}
library(MASS)
d0 = subset(D, PoorCare==0)
A0 = mvrnorm(7480, colMeans(d0[,4:5]), cov(d0[,4:5])) # 75%
# colMeans : OfficeVisits:11.5000ï¼›Narcotics:2.0612
# åˆ©ç”¨å¤šå…ƒå¸¸æ…‹åˆ†å¸ƒè¿‘ä¼¼ï¼ŒPoorCare == 0ï¼Œä¸¦éš¨æ©Ÿç”Ÿå‡º 7480å€‹æ¨£æœ¬

d1 = subset(D, PoorCare==1)
A1 = mvrnorm(2520, colMeans(d1[,4:5]), cov(d1[,4:5])) # 25%

A = rbind(A0, A1) %>% as.data.frame() 
A$PoorCare = c(rep(0L, 7480), rep(1L, 2520))
table(A$PoorCare)

```

è³‡æ–™æ¡†`A`ä¹‹ä¸­æœ‰ä¸€è¬å€‹ä¿æˆ¶çš„è³‡æ–™
```{r}
y = A$PoorCare
pred = predict(glm1, A, type="response")    # é æ¸¬ A
save(y, pred, payoff, file="Sim12B.Rdata")  # å­˜
```

```{r fig.height=3.2, fig.width=7}

cutoff = seq(0, 1, 0.01)                                       # æ¯0.01ç•«ä¸€é»ï¼Œæ©Ÿç‡

result = sapply(cutoff, function(p) {
  cm = table(factor(y == 1, c(F,T)), factor(pred > p, c(F,T))) # æ¯å€‹é–¾å€¼ä¸‹çš„æ··æ·†çŸ©é™£
  sum(cm * payoff)     ### sum of confusion * payoff matrix
  })

# æ··æ·†çŸ©é™£ table(factor(...))
# ç”¨factorè®Šæˆé¡åˆ¥ï¼Œç¢ºä¿ä¸€å®šæœ‰0ã€1æ¬„ä½ï¼Œå€‹æ•¸0å€‹ä¹Ÿç„¡å¦¨ï¼Œ2*2è·é™£
# (æ•¸å€¼çš„è©±ï¼Œå¦‚æœæœ‰ä¸€æ’å…¨ç‚º0ï¼ŒçŸ©é™£å¯èƒ½å¾2*2è®Šæˆ1*2...ï¼Œæœƒç„¡æ³•å°é½Šå ±é…¬çŸ©é™£&ç›¸ä¹˜)

i = which.max(result)                                          # å–æœ€å¤§çš„index

par(cex=0.7, mar=c(4,4,3,1))

plot(cutoff, result, type='l', col='cyan', lwd=2,
     main=sprintf("Optomal Expected Result: $%d @ %.2f",result[i],cutoff[i]))
abline(v=seq(0,1,0.1),h=seq(-300000,-100000,25000),col='lightgray',lty=3)
points(cutoff[i], result[i], pch=20, col='red', cex=2)         # iï¼Œæœ€ä½³æœŸæœ›å ±é…¬çš„é»

```

ğŸŒ· å•†å‹™è³‡æ–™çš„é€šå¸¸éƒ½ç›¸ç•¶å¤§ï¼Œæ‰€ä»¥æ¨¡æ“¬æ›²ç·šä¸€èˆ¬éƒ½æ¯”è¼ƒå¹³æ•´

<br><hr>

### ã€Dã€‘ç­–ç•¥æ¨¡æ“¬

ä½¿ç”¨`manipulate`å¥—ä»¶ï¼Œæˆ‘å€‘å¯ä»¥åœ¨RStudioä¹‹ä¸­åšå‹•æ…‹çš„æ¨¡æ“¬ ...

**ä½¿ç”¨`manipulate`å¥—ä»¶åšç­–ç•¥æ¨¡æ“¬**
```{r eval=F}
# echo - åœ¨è¼¸å‡ºæ–‡æª”ä¸­é¡¯ç¤ºä»£ç¢¼ï¼ˆé»˜èª = TRUEï¼‰
# eval - åœ¨å¡Šä¸­é‹è¡Œä»£ç¢¼ï¼ˆé»˜èª = TRUEï¼‰

library(manipulate) # æ“ç¸±

manipulate({
  payoff = matrix(c(TN,FN,FP,TP),2,2)                         # å ±é…¬çŸ©é™£
  
  cutoff = seq(0, 1, 0.01)
  
  result = sapply(cutoff, function(p) {
    cm = table(factor(y==1, c(F,T)), factor(pred>p, c(F,T))) 
    sum(cm * payoff) # sum of confusion * payoff matrix
  }) / 1000
  
  i = which.max(result)
  
  par(cex=0.7)
  
  plot(cutoff, result, type='l', col='cyan', lwd=2, main=sprintf(
    "Optomal Expected Result: K$%.2f @ %.2f",result[i],cutoff[i]),
    ylim=c(-320, -120))
  abline(v=seq(0,1,0.1),h=seq(-400,-100,25),col='lightgray',lty=3)
  points(cutoff[i], result[i], pch=20, col='red', cex=2)
},
                                                  
TN = slider(-100,0,   0,"TN(ç„¡è¡Œå‹•)",step=5),                 # å ±é…¬çŸ©é™£,åˆå§‹å€¼: 0
FN = slider(-100,0,-100,"FN(å¹³å‡é¢¨éšªæˆæœ¬)",step=5),           # å ±é…¬çŸ©é™£,åˆå§‹å€¼: -100
FP = slider(-100,0, -10,"FP(è¡Œå‹•æˆæœ¬)",step=5),               # å ±é…¬çŸ©é™£,åˆå§‹å€¼: -10
TP = slider(-100,0, -50,"TP(è¡Œå‹•æˆæœ¬+è¼ƒå°é¢¨éšªæˆæœ¬)",step=5)   # å ±é…¬çŸ©é™£,åˆå§‹å€¼: -50
) 

# slider : æ»‘å¡Š

```
<br>

<p class="qiz">
<span style="font-size:24px">`r "\U1F5FF"` ç·´ç¿’ï¼š </span><br>
åŸ·è¡Œ`Sim12.R`ï¼Œå…ˆä¾é è¨­çš„å ±é…¬çŸ©é™£å›ç­”ä¸‹åˆ—å•é¡Œï¼š<br>
&emsp; ã€Aã€‘ æœ€ä½³è‡¨ç•Œæ©Ÿç‡æ˜¯ï¼Ÿ å®ƒæ‰€å°æ‡‰çš„æœŸæœ›å ±é…¬æ˜¯å¤šå°‘ï¼Ÿ<br>
&emsp; ã€Bã€‘ ä»€éº¼éƒ½ä¸åšæ™‚ï¼Œè‡¨ç•Œæ©Ÿç‡å’ŒæœŸæœ›å ±é…¬å„æ˜¯å¤šå°‘ï¼Ÿ<br>
&emsp; ã€Cã€‘ æ¯ä½ä¿æˆ¶éƒ½åšæ™‚ï¼Œè‡¨ç•Œæ©Ÿç‡å’ŒæœŸæœ›å ±é…¬å„æ˜¯å¤šå°‘ï¼Ÿ<br>
&emsp; ã€Dã€‘ ä»¥ä¸Šå“ªä¸€ç¨®åšæ³•æœŸçš„æœ›å ±é…¬æ¯”è¼ƒé«˜ï¼Ÿ<br>
&emsp; ã€Eã€‘ åœ¨æ‰€æœ‰çš„å•†å‹™æƒ…å¢ƒéƒ½æ˜¯é€™ç¨®ç‹€æ³å—ï¼Ÿ<br><br>
&emsp;ã€Aã€‘è‡¨ç•Œæ©Ÿç‡:0.27 æœŸæœ›å ±é…¬:-183.11 <br>
&emsp;ã€Bã€‘éƒ½ä¸åš : è‡¨ç•Œæ©Ÿç‡:1 æœŸæœ›å ±é…¬:-250 <br>
&emsp;ã€Cã€‘éƒ½åš : è‡¨ç•Œæ©Ÿç‡:0 æœŸæœ›å ±é…¬:-200 <br>
&emsp;ã€Dã€‘éƒ½åš <br>
&emsp;ã€Eã€‘ä¸æ˜¯ï¼Œè¦è€ƒæ…® è¡Œå‹•æˆæœ¬ & è¼ƒå°é¢¨éšªæˆæœ¬<br><br>
&emsp;&emsp;&emsp; é€™ä¸¦ä¸é©ç”¨æ–¼æ¯ç¨®å•†æ¥­æƒ…æ³ï¼Œ<br>
&emsp;&emsp;&emsp; å› ç‚ºæ¯ç¨®å•†æ¥­æƒ…å¢ƒçš„æƒ…æ³ä»¥åŠæ¡å–è¡Œå‹•çš„æˆæœ¬éƒ½ä¸ç›¡ç›¸åŒï¼Œ<br>
&emsp;&emsp;&emsp; æ‰€ä»¥ä¸¦ä¸æ˜¯åœ¨æ¯ç¨®æƒ…æ³ä¸‹æ¡å–è¡Œå‹•æœƒæ¯”ä¸æ¡å–ä¾†å¾—å¥½ã€‚<br>
&emsp;&emsp;&emsp; å¦‚ç•¶FPç‚º20ã€TPç‚º60æ™‚å‰‡é¸æ“‡ä¸åšé æœŸå ±é…¬æœƒæ¯”åšé«˜<br><br>
è—‰ç”±èª¿æ•´å ±é…¬çŸ©é™£ï¼š<br>
&emsp; ã€Fã€‘ æ¨¡æ“¬å‡ºã€Œå…¨ä¸åšã€æ¯”ã€Œå…¨åšã€é‚„è¦å¥½çš„ç‹€æ³<br>
&emsp; ã€Gã€‘ ä¸¦èˆ‰å‡ºä¸€å€‹æœƒç™¼ç”Ÿé€™ç¨®ç‹€æ³çš„å•†å‹™æƒ…å¢ƒ<br><br>
&emsp;ã€Fã€‘TN(ç„¡è¡Œå‹•):0, FN(å¹³å‡é¢¨éšªæˆæœ¬):-100, FP(è¡Œå‹•æˆæœ¬):-20, TP(è¡Œå‹•æˆæœ¬+è¼ƒå°é¢¨éšªæˆæœ¬):-60 <br>
&emsp;&emsp;&emsp; å…¨ä¸åš: è‡¨ç•Œæ©Ÿç‡:1 æœŸæœ›å ±é…¬:-250ï¼Œå…¨åš: è‡¨ç•Œæ©Ÿç‡:0 æœŸæœ›å ±é…¬:-300 <br>
&emsp;ã€Gã€‘è‹¥æœ‰ä¸€é–“è‹¥æœ‰ä¸€å€‹é€£é–å•†åº—ï¼Œ<br>
&emsp;&emsp;&emsp; ç¸½å…¬å¸æ±ºå®šå…¨éƒ¨åˆ†åº—éƒ½è¦ä½¿ç”¨æ™‚ä¸‹æœ€æ–°å‹æœ€æ˜‚è²´çš„é˜²ç›œå™¨ä»¥åŠé«˜éšä¿å…¨ä¾†é˜²ç¯„ç›œç«Šï¼Œ<br>
&emsp;&emsp;&emsp; ä½†å…¶å¯¦å¹³å‡è¢«ç«Šç›œé‡‘é¡ä¸é«˜ï¼Œç›œç«Šæƒ…æ³ä¹Ÿä¸å¸¸ç™¼ç”Ÿï¼Œé‚£éº¼åœ¨æ­¤æƒ…æ³ä¸‹ï¼Œ<br>
&emsp;&emsp;&emsp; æ¡å–è¡Œå‹•ï¼ˆé«˜ç´šé˜²ç›œç³»çµ±åŠäººå“¡ï¼‰çš„æˆæœ¬å°±éé«˜ï¼Œå°è‡´æœŸæœ›å ±é…¬ä½ã€‚<br>
&emsp;&emsp;&emsp; å…¨ä¸åšå…¨ä¸åšå°±æ¯”å…¨åšè¦å¥½ã€‚<br><br>
&emsp;&emsp;&emsp; åœ¨é†«ç™‚ä¸Šå¯èƒ½ä¸€ä»½è—¥20å…ƒ(FP)ï¼Œå¯é™ä½é¢¨éšªæˆæœ¬è‡³40ï¼Œ<br>
&emsp;&emsp;&emsp; è¶…éè‡¨ç•Œæ©Ÿç‡å°±åƒè—¥(å°±ç®—æˆæœ¬é«˜é™ä½çš„é¢¨éšªåˆä½) <br><br>
æœ‰äº”ç¨®æˆæœ¬åˆ†åˆ¥ç‚º`$5, $10, $15, $20, $35`çš„ä»‹å…¥æ–¹æ³•ï¼Œå®ƒå€‘åˆ†åˆ¥å¯ä»¥å°‡é¢¨éšªæˆæœ¬å¾`$100`é™ä½åˆ°`$70, $60, $50, $40, $30` ...<br>
&emsp; ã€Hã€‘ å®ƒå€‘çš„æœ€ä½³æœŸæœ›å ±é…¬åˆ†åˆ¥æ˜¯å¤šå°‘ï¼Ÿ<br>
&emsp; ã€Iã€‘ å“ªä¸€ç¨®ä»‹å…¥æ–¹æ³•çš„æœ€ä½³æœŸæœ›å ±é…¬æ˜¯æœ€å¤§çš„å‘¢ï¼Ÿ<br><br>
&emsp;ã€Hã€‘# FP:è—¥å¤šè²´(è¶Šå·¦è¶Šè²´)ï¼ŒTP:è—¥æœ‰æ•ˆå—(è¶Šå·¦è¶Šæ²’æ•ˆ) <br>
&emsp;&emsp;&emsp; (æˆæœ¬,é¢¨éšªæˆæœ¬) : ($5,$70),($10,$60),($15,$50),($20,$40),($35,$30) <br>
&emsp;&emsp;&emsp; -5 & -70-5: å ±å„Ÿ:-217.56 æ©Ÿç‡:0.27 <br>
&emsp;&emsp;&emsp; -10 & -60-10 : å ±å„Ÿ:-215.02 æ©Ÿç‡:0.36 <br>
&emsp;&emsp;&emsp; -15 & -50-15 : å ±å„Ÿ:-211.54 æ©Ÿç‡:0.36 <br>
&emsp;&emsp;&emsp; -20 & -40-20 : å ±å„Ÿ:-207.10 æ©Ÿç‡:0.43 <br>
&emsp;&emsp;&emsp; -35 & -30-35 : å ±å„Ÿ:-217.53 æ©Ÿç‡:0.48 <br>
&emsp;ã€Iã€‘(æˆæœ¬,é¢¨éšªæˆæœ¬) : ($20,$40) : å ±å„Ÿ:-207.10 æ©Ÿç‡:0.43 <br><br>
</p class="qiz">


<br><hr>

ğŸŒ **åƒè€ƒæ¨¡æ“¬ç¨‹å¼**
```{r fig.height=5, fig.width=7}
pacman::p_load(plotly)

# å ±é…¬çŸ©é™£
PMX = list(
  c(0,-100, -5,-75), c(0,-100,-10,-70), c(0,-100,-15,-65),
  c(0,-100,-20,-60), c(0,-100,-35,-65)) %>% 
  lapply(matrix, nrow=2, ncol=2)

# do.call å¾åç¨±ã€å‡½æ•¸ä»¥åŠè¦å‚³éçµ¦å®ƒçš„åƒæ•¸åˆ—è¡¨ï¼Œæ§‹é€ ä¸¦åŸ·è¡Œå‡½æ•¸èª¿ç”¨
do.call(rbind, lapply(1:length(PMX), function(i) {
  
  r = sapply(cutoff, function(p) {
    cm = table(factor(y==1,c(F,T)), factor(pred>p,c(F,T))) 
    sum(cm * PMX[[i]]) })
  
  data.frame(drug=paste0("drug_",i), cutoff=cutoff, exp.payoff=r)
  })) %>% 
  ggplot(aes(x=cutoff, y=exp.payoff, col=drug)) +
  geom_line() + theme_bw() -> p

ggplotly(p)

```

é¡§å®¢åƒ¹å€¼ç®¡ç†:https://bap2.cm.nsysu.edu.tw/?page_id=1689

<br><br><br><hr>
