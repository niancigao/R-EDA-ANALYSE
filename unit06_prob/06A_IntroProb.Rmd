---
title: UNIT06A 機率概論
author: Tony Chuo, NSYSU
date: "`r Sys.time()`"
output: 
  html_document:
    theme: spacelab
    highlight: pygments
    css: ../etc/style.css
---

```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE) 
options(scipen=20, digits=5, width=80, tibble.print_min=4)
rmarkdown::find_pandoc(version = '2.7.3')
```
<br>

<span style='font-size:16px; font-family:"Arial Black"'>
<b><u>👨‍🏫 **KEY POINTS :**</u></b></span><br>

🔑 A data frame column is an attribute of interest. In terms of statistics, we call it a **variable**.  

🔑 We have a few ways to describe the varying values of a variable.

+ **Statistics** (`mean`,`sd`) for numeric and **Counts** (`table`) for categorical variables.
+ **Histograms** for continuous/numeric and **Bar Plots** for discrete/categorical variables.
+ **Distribution Functions (PDF/CDF)** for estimating **Probabilities**.

🔑 In R we can ...

+ Represent <z>Variables</z> in Vectors.
+ Make <z>Distribution</z> functions directly (直接) from data or via (通過) simulation (模擬). 
+ Estimate <z>Probabilities</z> with those distribution functions. 

<br><hr>


```{r results='hide', message=FALSE, warning=FALSE}
pacman::p_load(dplyr)
```


### 1. Random Draw and Repeatition

Most of the statistics theories were built upon two fundamental assumptions: 

+ 隨機抽樣 Random Draw 
+ 無限重複 Infinite Repetition

Mathematically, these hypothetical concepts are somehow difficult to understand. 
Fortunately, now we can elaborate (闡述) these conceptual (概念) ideas with data in R. 

<br>

##### 1.1 Random Draw - sample()

The most common random draw function in R is `sample()`  

+ `sample(x, n)` randomly draws `n` elements from `x` without replacement
+ `sample(x, n, replace=T)` randomly draw `n` elements from `x` with replacement

Randomly draw a number from 1 to 6 ...
```{r}
sample(1:6, 1)
```
Rut it 10 times, the you'd know what it means by 'random'.

<br>

##### 1.2 Repeated Experiment - replicate()

`replicate(n, expr)` evaluate the random `expr` `n` time  

```{r}
replicate(20, sample(1:6, 1))  # an vector
```
It returns an vector of 20 integers. Every time you run it, it'll returns a different result.

<br><br>

### 2. Random Experiment and Variable

##### 2.1 Random Experiment as R Function

In R, we define any <z>Random Experiment</z> as a function that generate random results. It implies that the there are some random elements in the function definition  ... 
```{r}
exSum3 = function() { sum( sample(1:6, 3, T) ) }
```

Run it 10 times.
```{r}
exSum3()
```
It looks 'random', isn't it.

<br>

##### 2.2 Random Variable as the Return Value of Random Experiment

🌻 A <z>Random Variable</z> is defined as the resultant value of a specific <z>Random Experiment</z>.

Because an random experiments return random values, their corresponding random variables varies randomly.  

Let's define a random experiment that returns the maximum value of three fair dices.  
```{r}
exMax3 = function() { max( sample(1:6, 3, T) ) }
```

When we repeat an random experiment N time, we will have a **resultant vector** of length N.  This resultant vector is a <z>random sample</z> of the corresponding random variable.

If we define a random variable `rvMax3` on the random experiment `reMax3`, we can take a 20-point random sample of `rvMax3` by ... 
```{r}
rvMax3.20 = replicate(20, exMax3())
```

<br>

<span style='font-size:16px; font-family:"Arial Black"'>
<b><u>🚴 **EXERCISE :**</u></b></span><br>

👉 Define a random experiment that randomly draw 3 numbers out of `1:10` and returns the minimum. 
```{r}
rx = function() { min(sample(1:10, 3)) }
rx()

```

👉 Take a random sample of size 400 form the corresponding random variable.
```{r}
rv = replicate(400, rx())
rv

```

👉 What is the best way to present this sample to you boss?
```{r}
table(rv) %>% barplot

```

<br><br>

### 3. The Concept of Distribution

<z>Distribution</z> := a formula that describes how the values of a variable spread over a domain. 

There are 3 different ways to define a random variable:

+ Real (Empirical) Data observed from the field
+ Simulated Data generated by some programs
+ Random Variables are Theoretical (Conceptual)

##### 3.1 the distribution of real/simulated data

Supposed that we have a data vector `skin` that represents the skin colors of a population of 1,000 people.
```{r}
skin = c(rep('Black',400),rep('White',300),rep('Yellow',200),rep('Red',100))
```

The distribution of `skin` can be represented as a numeric table of counts or proportions ...
```{r}
rbind(
  counts = table(skin),
  factions = table(skin) %>% prop.table
  )
```

or we can visualize the distribution in two ways 

+ in frequency (counts)
+ in proportion (fractions)

```{r fig.height=2, fig.width=7}
par(mar=c(3,5,3,1),mfrow=c(1,2),cex=0.7)

table(skin) %>% 
  barplot(main="the distribution of skin colors", ylab="counts")

table(skin) %>% prop.table %>% 
  barplot(main="the distribution of skin colors", ylab="propotions")
```

🌷 Quite often we'd map the **proportions** in the distribution to the **probabilities** of their corresponding events. However, this mapping should be conducted carefully, as will be explained below.

<br>

##### 3.2 the distribution of random variable

We can define a random variable `rvSkin` on the random experiment `exSkin` which randomly draws a data point from `skin`.  
```{r}
exSkin = function() {sample(skin, 1)}
exSkin()

```

To take a sample of size 100, we repeat the experiment 100 times. 
```{r}
rvSkin100 = replicate(100, exSkin())
rvSkin100

```

The distribution of this sample is
```{r}
table(rvSkin100) %>% prop.table 

```
Is the distribution of the sample exactly the same as that of the data vector `skin`?  NO


```{r}
sapply(2:6, function(i) table(replicate(10^i, exSkin())) ) %>% prop.table(2)

# 重複 10^2 10^3 10^4 10^5 10^6 次 列方向機率總合為1
# 看重複 n 次下，各顏色比例是否趨近母體

```
As the size of the sample increased, the distribution of the sample become closer to that of the data.  But it does not meet the exact numbers even when we take a sample of 1 million (10^6). 

<br><br>

### 4. The Connection between Distribution and Probability 

Theoretically, the sample distribution will asymptotically be equal to the data distribution when the sample size approaches infinity. This is exactly the underlying logic that we can map the distribution of empirical data to the probabilities of the corresponding events.

<span style='font-size:16px; font-family:"Arial Black"'>
<b><u>🔑 **KEY POINTS :**</u></b></span><br>

+ Practically, we can define the probability of an event as the ratio of its occurrence under a very large number of repetitions.
+ Probability in not a real thing. It is a theoretical concept that defines on **infinite repetitions of random sampling**.   
+ When we use empirical, theoretical or inferential distribution to estimate the probabilities of events, we should remember that, since the premises of perfect randomness and infinity never hold, our estimations are always subject to some level of error.     

<br><br>

### 5. Simulating for the Expected Value 

The <z>Expected Value</z> bears a similar asymptotic implication. Expected values used to be derived from assumptions and deduction mathematically. For common cases, there are a lot of well defined math formula. For example, the combined outcomes of a series of independent events of pre-defined probabilities is named **Multinomial Distribution**. The probability of an Multinational event take the form of ...

$$
p = \frac{n!}{k_1!\,k_2\,...\,k_i!} \; \prod p_i^{k_1} \\ 
\frac{10!}{4!\,3!\,2!\, 1!} (.4)^4 \, (.3)^3 \, (.2)^2 \, (.1)^1  
\; \simeq \; 0.034836
$$

Randomly drawing 10 points from `skin`, the probability that we have 4 blacks, 3 whites, 2 yellows and 1 red is less than 3.5%. It's hard to do the math or remember the formula though. 

Fortunately, in R we can simulate the experiment and let the computer estimates the expected value for us. The asymptotic property implies that our estimation would approach the true value when the number of repetitions is large enough. The questions is - how large is enough?
<br>每種分布狀況可能不同，此題在 10^4 時，模擬結果收斂到理論值<br>

Let's define a function `Simulated.Prob(k)` that repeats the experiment `sample(skin,10)` `k` times, and return the proportions that *the outcome of the experiment* match *the distribution of our data*.  

```{r}
# convert skin in to a factor for faster execution (執行)
sf = factor(skin, c("Black","White","Yellow","Red"))

# prepare for parallel simulation (並行模擬)
# 使用 Future 將函數並行應用於元素
pacman::p_load(future.apply) 

# it specifies (指定) how future():s are resolved，順序或併行
plan(multisession)

zSimulated.Prob = function(k){
  
  future_replicate( k, as.integer(table(sample(sf, 10))), future.seed=TRUE) %>%
  apply(2, identical, 4:1) %>% mean

###########################################################################################  
  
}

# multisession: Resolves futures asynchronously (異步) (in parallel) in separate (分離) R sessions running in the background on the same machine.

# identical(a, b)

```

By increasing `k`, we approach the 'infinity' gradually ...
```{r}
x = as.integer(10^seq(1,6,0.2))

t0 = Sys.time() #顯示現在系統的時間
y = sapply(x, function(k) { cat(k,"- "); zSimulated.Prob(k) })
Sys.time() - t0 #總共花多少時間

```
In a few lines of code we can simulate this somewhat complicated experiment. And the the power of modern computer can execute this simulation 2.7 million times in 1.5 minutes.

```{r fig.height=3, fig.width=6.5}
par(mfrow=c(1,1), mar=c(5,5,3,2), cex=0.8)

plot(log(x,10), y, type="b")
abline(h=0.0348, col='red', lty=2) # probability of an Multinational

```

See? The result of the simulation <z>converges</z> to the theoretical value when the number of repetition exceeds ~10,000 (10^4).     

<br>

<span style='font-size:16px; font-family:"Arial Black"'>
<b><u>🌞 **TAKE AWAYS :**</u></b></span><br>

🌻 Modern business is full of complicated cases that are never covered in Statistics textbook.

🌻 When it is too hard to do the math, computer simulation may help to make good enough estimation in reasonable time 

🌻 Mastering (掌握) R so you can simulate whatever you can specify !!!

<br>

![](fig/StatDistOp.png){height=350}

<br><br>












