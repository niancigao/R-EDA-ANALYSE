---
title: UNIT10A：相關性，變數之間的關係
author: 中山大學管理學院 卓雍然
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---

```{r results='hide', message=FALSE, warning=FALSE, echo=F}
# Formating Codes.  Do not change the codes in this chunk.<br>
#rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8)
options(scipen=20, digits=5, width=80)
if(!require(pacman)) install.packages("pacman")
```
<hr>

```{r results='hide', message=FALSE, warning=FALSE}
pacman::p_load(dplyr, ggplot2, car, vcd, GGally, mvtnorm)
```
<br>

### 【A】批發商資料集

```{r}
W = read.csv('data/wholesales.csv')
W$Channel = factor( paste0("Ch",W$Channel) )
W$Region = factor( paste0("Reg",W$Region) )
W[3:8] = lapply(W[3:8], log, base=10)
summary(W)
```
<br>

### 【B】連續變數的相關性(係數) Correlation

**B1a. 點狀圖 Simple Scatter Plot**
```{r fig.height=3.2, fig.width=3.2}
par(cex=0.7, mar=c(4,4,2,2))
plot(W$Milk, W$Grocery)
```

**B1b. 點狀圖+回歸線 Scatter Plot with Regrssion Line**
```{r fig.height=3.2, fig.width=3.2}
ggplot(W, aes(x=Milk, y=Grocery)) +
  geom_point(alpha=0.3) +
  geom_smooth(method="lm") #回歸線

# method 類型常見的lm\glm\gam\loess\rlm等
# 當數據集記錄小於1000時,method的默認參數即為loess,大於1000時則為gam
# 誤差範圍的顏色帶，默認se=TRUE

# geom_smooth()、geom_path()、geom_line()
# https://zhuanlan.zhihu.com/p/27342288

```

**B2. 回歸係數 Correlation**
$$r_{xy}=\frac{Cov(x,y)}{\sigma_x \sigma_y}
=\frac{\Sigma_{i=1}^n(x_i - \bar{x})(y_i - \bar{y})}
{\sqrt{\Sigma_{i=1}^n(x_i - \bar{x})^2} \sqrt{\Sigma_{i=1}^n(y_i - \bar{y})^2}}$$

```{r}
cor(W$Milk, W$Grocery)
```


**B3. 回歸係數檢定 Correlation Test**
```{r}
cor.test(W$Milk, W$Grocery)
```

<span style="font-size:20px">`r "\U1F4A1"` ： </span>
簡單講，$p-value$大致可以視為「沒有關係」的機率(準確的說它並不是這樣)

<span style="font-size:20px">`r "\U1F4A1"` ： </span>
如果「沒有關係」的機率很小，我們就推路這效果是「顯著」的

<span style="font-size:20px">`r "\U1F4A1"` ： </span>
$p-value$: 給定虛無假設($H_0:r=0$)，檢定統計量($t$)大於觀察值($24.4$)的機率

<span style="font-size:20px">`r "\U1F5FF"` ： </span>
當$p = 0.05$時，對立假設($H_A$)為真的機率是？

<span style="font-size:20px">`r "\U1F4A1"` ： </span>
貝氏定理：$P(A|B) = P(B|A) \cdot P(A) / P(B)$
<br>

**B4. Simulating 模擬 Bi-Variate Normal Distibution**
```{r  fig.height=6, fig.width=6}
par(cex=0.7, mar=c(1,1,1,1), mfrow=c(3,3))

for(r in seq(-1,1,0.25)) {
  mu = c(0,0)
  sigma = matrix(c(1,r,r,1),nrow=2)   # covariance matrix 
  rmvnorm(500, mu, sigma) %>% plot(col='gray') # random多元正態
  text(0,0,r,cex=3,col='blue',font=2)  
  # 位置；內容；資料點大小；font:字體
  }
```
<br><hr>

### 【C】相關性矩陣

**C1. Matrix of Correlation Coefficients**
```{r}
cor(W[,3:8]) %>% round(3)
```

<span style="font-size:20px">`r "\U1F4A1"` ： </span>
相關性矩陣：(a)對角線等於1；(b)左下、右上對稱

**C1. Matrix of Scatter Plots**
```{r fig.height=8, fig.width=8}
scatterplotMatrix(W[,3:8])

# car::scatterplotMatrix(W[,3:8])
# 散點圖矩陣，car包

```
<br><hr>

### 【D】類別變數之間的關聯性 Association

**D1. 關聯性卡方檢定 Chisq-Test for Association**
```{r}
table(W$Channel, W$Region) %>% chisq.test()

#先有表格，再做關聯性卡方檢定

```

+ The association between `Channel` and `Region` is not significant
+ I.e., The distribution of `Channel` does not depends on `Region` and vice versa (反之亦然).

**D2. 馬賽克圖 Mosaic Plot**
```{r}
library(vcd)

structable(Channel ~ Region, W) %>% 
  mosaic(shade=T, labeling=labeling_residuals) #標記殘差

# 類別變數的關係，結構化列聯表，類似於馬賽克的構造
# P-value:0.114,有點尷尬，關係有但不明顯
# 沒顏色，Channel跟Region沒啥差別

```

**D3. Another Example**
```{r}
haireye <- margin.table(HairEyeColor, 1:2)
haireye

# 對於數組形式的列聯表，計算 sum of table entries for a given index
# HairEyeColor 的兩個表格(男、女)對應處相加

```

頭髮顏色的邊際機率
```{r}
(mpHair = rowSums(haireye)/sum(haireye)) # marginal prob.
```

眼睛顏色的邊際機率
```{r}
(mpEye = colSums(haireye)/sum(haireye)) # marginal prob.
```

**若頭髮、眼睛顏色是不相關的(Independent)**，則頭髮、眼睛的**聯合機率分佈**為<br>
$(給定m\times 1 列向量\mathbf{u}，和1 \times n 行向量\mathbf {v} ，它們的外積\mathbf{u} \otimes \mathbf{v}被定義為m\times n矩陣\mathbf{A})$
```{r}
(expProb = mpHair %o% mpEye) 
# %o%	矩陣外積乘法 (f(x,y)=f(x)*f(y)，每行列都兩兩相乘)

```

```{r}
sum(expProb)
```

**若頭髮、眼睛顏色是不相關的(Independent)**，則各頭髮、眼睛組合的期望值是
```{r}
(expVal = expProb * sum(haireye))
```

**標準化殘差(Standardized Residual)** 
```{r}
(s.res = (haireye - expVal) / sqrt(expVal))
# 標準化殘差(Standardized Residual)
# 跟馬賽克圖上的數字一樣

```

**馬賽克圖** 
```{r}
mosaic(haireye, shade=T, labeling=labeling_residuals)
```

<p class="wwl">
<span style="font-size:20px">`r "\U1F4A1"` 學習重點：</span><br>
&emsp; ■ The Association between `Hair` and `Eye` is significant<br>
&emsp; ■ For Black-Hair:<br>
&emsp; &emsp; ■ the propotion of Brown-Eye is significantly higher than `the expected`<br>
&emsp; &emsp; ■ the propotion of Blue-Eye is significantly lower<br>
&emsp; ■ For Red-Hair:<br>
&emsp; &emsp; ■ he propotion of Green-Eye is significantly higher<br>
&emsp; ■ For Blond-Hair:<br>
&emsp; &emsp; ■ the propotion of Brown-Eye is significantly lower<br>
&emsp; &emsp; ■ the propotion of Blue-Eye is significantly higher<br>
&emsp; &emsp; ■ the propotion of Hazel-Eye is significantly lower<br>
</p class="wwl"><br>


**D4. The `Expected Value` in Contingent Table**
```{r}
( expected = independence_table(haireye) )
#(expProb = mpHair %o% mpEye) 
#(expVal = expProb * sum(haireye))

```

It is derived from the marginal probability in both directions
```{r}
(rowSums(haireye) %o% colSums(haireye)) / sum(haireye)
```

**D5. Residuals**
```{r}
( residuals = haireye - expected ) 
```

**D6. Standardized Residuals**
```{r}
(std.residuals = residuals / sqrt(expected)) 
```

<br>
<span style="font-size:20px">`r "\U1F9D9"`</span>
熱圖與馬賽克圖的比較 [Heatmap.Rmd](http://140.117.69.135:4949/tonychuo/Heatmap.Rmd)

<br><hr>

### 【E】類別與連續變數之間的關係 - GGally
```{r fig.height=9, fig.width=9}
library(GGally)
ggpairs(iris, aes(colour = Species, alpha=0.4),
        lower=list(combo = wrap("facethist", binwidth = 0.2)))

#每個變量組合都根據它們是否是：
#連續：例如“points”（默認下限）、“smooth”、“smooth_loess”、“density”
#         “cor”（默認上限）或“blank”
#組合：例如“box”、“box_no_facet”（默認上限）、“dot”
#         “dot_no_facet”、“facethist”、“facetdensity”、“denstrip”或“blank”
#離散的：例如“ratio”、“facetbar”或“blank”

#對角線上的圖可以是：
#連續：“densityDiag”、“barDiag”、“blankDiag”
#離散：“barDiag”、“blankDiag”

#術語 facet，它是指將單個 plot 拆分為兩個或多個面板（facets）

# https://mran.microsoft.com/snapshot/2016-01-12/web/packages/GGally/vignettes/ggpairs.html

# https://mp.weixin.qq.com/s?__biz=MzA3MTM3NTA5Ng==&mid=2651061214&idx=2&sn=d7f7da833dd5eeaeaeb2ec0bd332bb57&chksm=84d9da49b3ae535fe87c6e776a9df84ced981a72a241d1c70d6be9c810b665dc3fc58cb76ae4&scene=21#wechat_redirect

# https://blog.csdn.net/kMD8d5R/article/details/89735027
```

### 【F】類別與連續變數的各種可能關係圖示

##### F1. 單一類別變數
```{r fig.height=2.5}
par(cex=0.8, mar=c(2,3,1,1), mfrow=c(1,1))
table(W$Channel) %>% barplot
```

##### F2. 單一連續變數
```{r fig.height=3, fig.width=6.4}
par(cex=0.8, mar=c(4,3,1,1))
hist(W$Fresh)
```

##### F3. 兩類別變數
```{r}
structable(Channel ~ Region, W) %>% 
  mosaic(shade=T, labeling=labeling_residuals)
```
<span style="font-size:20px"><br>`r "\U1F4A1"`： </span>
如果類別變數裡面有太多分類(或各分類的數量很不平衡)，我們應該考慮使用熱圖<br>

##### F4. 類別 X 數量
類別和數量變數擺在一起，就可以做分類統計
```{r}
tapply(W$Milk, W$Region, sum)
```

**分類平均**
```{r}
tapply(W$Milk, list(W$Channel, W$Region), mean)
```

**分類總和**
```{r}
tapply(W$Milk, list(W$Channel, W$Region), sum)
```

另一種做法
```{r}
xtabs(Milk ~ Channel + Region, data=W)
```

```{r}
ggplot(W, aes(x=log(Milk))) +
  geom_histogram(aes(fill=Region), alpha=0.5, bins=20) +
  facet_grid(Channel~Region) +
  labs(title="Distribtion of Sales of Milk")
```

```{r fig.height=2.5, fig.width=7.5}
ggplot(W, aes(x=log(Milk))) +
  geom_density(aes(fill=Region), alpha=0.5) +  # compare the density of Region 
  facet_grid(~Channel) +                       # by Channel
  labs(title="Density of Sales of Milk")
```

```{r fig.height=2.5, fig.width=7.5}
ggplot(W, aes(x=log(Milk))) +
  geom_density(aes(fill=Channel), alpha=0.5) +  # compare the density of Channel
  facet_grid(~Region) +                         # by Region 
  labs(title="Density of Sales of Milk")
```


##### F5. 數量 X 數量 (X 類別)
```{r fig.height=4, fig.width=4}
ggplot(W, aes(x=log(Milk), y=log(Fresh))) +
  geom_point() +
  stat_smooth(formula=y ~ x,method="lm",se=F)
```

```{r fig.height=3, fig.width=6}
ggplot(W, aes(x=log(Milk), y=log(Fresh))) +
  geom_point() +
  stat_smooth(formula=y ~ x,method="lm", se=F) +
  facet_grid(~Region)

# geom_smooth():using formula 'y ~ x'

```

```{r fig.width=6}
ggplot(W, aes(x=log(Milk), y=log(Fresh))) +
  geom_point() +
  stat_smooth(formula=y ~ x,method="lm", se=F, col='red') +
  facet_grid(Channel~Region)
```

<br>
<span style="font-size:20px">`r "\U1F4A1"` 學習重點：</span>
存在整個族群的關係和個別分群之中的關係有可能是不同(甚至是相反)的！

<br><br><br><hr>



