---
title: "AS2-1: æ•¸ä½åµæ¢"
author: "Group-00"
date: "`r Sys.time()`"
output: 
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---

```{r echo=F, results='hide', message=FALSE, warning=FALSE}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8); options(scipen=20, digits=4, width=90)
z = Sys.setlocale("LC_TIME", "C")

if(!require(devtools)) install.packages("devtools")
if(!require(pacman)) install.packages("pacman")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(tidyr)) install.packages("tidyr")
if(!require(stringr)) install.packages("stringr")
pacman::p_load(dplyr,ggplot2,tidyr,stringr)
```
<br><hr>

çŠ¯ç½ªæ˜¯ä¸€å€‹åœ‹éš›é—œæ³¨çš„å•é¡Œï¼Œä½†å®ƒåœ¨ä¸åŒçš„åœ‹å®¶ä»¥ä¸åŒçš„æ–¹å¼è¨˜éŒ„å’Œè™•ç†ã€‚ åœ¨ç¾åœ‹ï¼Œè¯é‚¦èª¿æŸ¥å±€ï¼ˆFBIï¼‰è¨˜éŒ„äº†æš´åŠ›çŠ¯ç½ªå’Œè²¡ç”¢çŠ¯ç½ªã€‚ æ­¤å¤–ï¼Œæ¯å€‹åŸå¸‚éƒ½è¨˜éŒ„äº†çŠ¯ç½ªè¡Œç‚ºï¼Œä¸€äº›åŸå¸‚ç™¼å¸ƒäº†æœ‰é—œçŠ¯ç½ªç‡çš„æ•¸æ“šã€‚ ä¼Šåˆ©è«¾ä¼Šå·èŠåŠ å“¥å¸‚å¾2001å¹´é–‹å§‹åœ¨ç·šç™¼å¸ƒçŠ¯ç½ªæ•¸æ“šã€‚ èŠåŠ å“¥æ˜¯ç¾åœ‹äººå£ç¬¬ä¸‰å¤šçš„åŸå¸‚ï¼Œäººå£è¶…é270è¬ã€‚ åœ¨é€™å€‹ä½œæ¥­è£¡é¢ï¼Œæˆ‘å€‘å°‡é—œæ³¨ä¸€ç¨®ç‰¹å®šé¡å‹çš„è²¡ç”¢çŠ¯ç½ªï¼Œç¨±ç‚ºã€Œæ±½è»Šç›œç«Šã€ï¼Œ æˆ‘å€‘å°‡ä½¿ç”¨Rä¸­çš„ä¸€äº›åŸºæœ¬æ•¸æ“šåˆ†æä¾†äº†è§£èŠåŠ å“¥çš„æ±½è»Šç›œç«Šç´€éŒ„ã€‚ è«‹è¼‰å…¥æ–‡ä»¶â€œdata/mvtWeek1.csvâ€ã€‚

ğŸŒ» ä»¥ä¸‹æ˜¯å„æ¬„ä½çš„å®šç¾©ï¼š

+ `ID`: äº‹ä»¶ID
+ `Date`: æ—¥æœŸèˆ‡æ™‚é–“
+ `LocationDescription`: å¤±ç«Šåœ°é»
+ `Arrest`: æ˜¯å¦ç ´æ¡ˆ
+ `Domestic`: æ˜¯å¦ç‚ºå®¶åº­çŠ¯ç½ª
+ `Beat`: å°å€ä»£ç¢¼
+ `District`: å€ç¢¼
+ `CommunityArea`: ç¤¾å€ä»£ç¢¼
+ `Year`: å¹´åˆ†
+ `Latitude`: ç·¯åº¦
+ `Longitude`: ç¶“åº¦


ğŸŒ» è—‰ç”±åˆ†æé€™äº›ç´€éŒ„ï¼Œæˆ‘å€‘å¯ä»¥ï¼š

+ äº†è§£ã€Œæ±½è»Šç›œç«Šã€äº‹ä»¶çš„æ•´é«”ç‹€æ³å’Œè¶¨å‹¢
+ æè¿°ã€Œæ±½è»Šç›œç«Šã€äº‹ä»¶åœ¨æ™‚ã€ç©ºé–“ä¹‹ä¸­çš„åˆ†ä½ˆç‹€æ³
+ åšç‚ºè­¦åŠ›é…ç½®çš„åƒè€ƒ


ğŸŒ» é€™å€‹ç·´ç¿’çš„å­¸ç¿’é‡é»æ˜¯ï¼š

+ å­—ä¸²å’Œæ—¥æœŸ(æ™‚é–“)è³‡æ–™çš„è½‰æ›
+ ç·´ç¿’ä½¿ç”¨åˆ†é¡è¨ˆæ•¸å’Œåˆ†é¡çµ±è¨ˆåŠŸèƒ½ `table` and `tapply`


<br>

- - -

###  Section-1 Loading the Data

Read the data into a data frame `D`. 
```{r}
D = read.csv("data/mvtWeek1.csv")
```
As I said, the names of your major data frame is the shorter the better. 

ã€1.1ã€‘How many rows of data (observations) are in this dataset?
```{r}
nrow(D)
#191641
```

ã€1.2ã€‘How many variables are in this dataset?
```{r}
ncol(D)
#11
```

Let's also check the data types of these variables 
```{r}
str(D)
#$ ID                 : int
#$ Date               : chr  
#$ LocationDescription: chr  
#$ Arrest             : logi 
#$ Domestic           : logi 
#$ Beat               : int 
#$ District           : int 
#$ CommunityArea      : int  
#$ Year               : int  
#$ Latitude           : num  
#$ Longitude          : num  
```

and do a quick summary on them.
```{r}
summary(D)
```


ã€1.3ã€‘Using the "max" function, what is the maximum value of the variable `ID`?
```{r}
max(D$ID)
```


ã€1.4ã€‘ What is the minimum value of the variable `Beat`?
```{r}
min(D$Beat)
```


ã€1.5ã€‘ How many observations have value TRUE in the `Arrest` variable (this is the number of crimes for which an arrest was made)?
```{r}
sum(D$Arrest)
```

What is the average arrest rate of car thief events?
```{r}
mean(D$Arrest)
```

ã€1.6ã€‘ How many observations have a `LocationDescription` value of `ALLEY`?
```{r}
sum(D['LocationDescription']=='ALLEY')
```
<br><br>


### Section-2 Processing Date and Time in R

ã€2.1ã€‘ In what format are the entries in the variable Date?

+ Month/Day/Year Hour:Minute
+ Day/Month/Year Hour:Minute
+ Hour:Minute Month/Day/Year
+ Hour:Minute Day/Month/Year

```{r}
head(D$Date)  # Month/Day/Year Hour:Minute
```

ğŸŒ Date and Time are quite troublesome. Naturally the time line is a rational linear dimension. However, these nice real-number properties are all messed up in human society. Months have different days. Week may span over two months. The worst is, people record date and time in so many different formats that computers cannot read them automatically. Therefore, dates and time are usually read in as character strings. We have to manually look into the strings, recognize the format and then convert them into `Date` or `POSIXct` (name of a standard timing system) data types before we can properly using them in our programs. For an example, we need to observe the format in `D$date` and convert this `chr` column into a `POSIXct` vector (`ts`). 

```{r}
ts = as.POSIXct(D$Date, format="%m/%d/%y %H:%M")

#æ—¥æœŸå‡½å¼ as.Date() å¯ä»¥å°‡æ–‡å­—å‹å¼çš„æ—¥æ­·æ—¥æœŸ (calendar date) è½‰æ›æˆ {R} çš„ æ—¥æœŸé¡åˆ¥(**Dates class) ç‰©ä»¶.
#æ—¥æœŸå‡½å¼ strptime() å¯ä»¥å°‡æ–‡å­—å‹å¼çš„æ—¥æ­·æ™‚é–“è½‰æ›æˆ {R} çš„ æ—¥æœŸ-æ™‚é–“é¡åˆ¥ç‰©ä»¶''
#æ—¥æœŸå‡½å¼ `as.POSIXlt()` èˆ‡ `as.POSIXct()` å¯ä»¥å°‡æ—¥æœŸ-æ™‚é–“é¡åˆ¥ç‰©ä»¶â€™â€™ åˆ†åˆ¥è½‰æ›æˆ POSIXlt, POSIXcté¡åˆ¥æ ¼å¼.
#æ—¥æœŸå‡½å¼format()å¯ä»¥å°‡ {R} çš„ ``æ—¥æœŸ-æ™‚é–“é¡åˆ¥ç‰©ä»¶'' è½‰æ›æˆä¸€èˆ¬äººå¯è®€çš„æ–‡å­—å‹å¼çš„æ—¥æœŸ, æ—¥, æ˜ŸæœŸ, æœˆ, èˆ‡æ™‚é–“.

#POSIXct: éå¸¸å¤§çš„æ­£æ•´æ•¸, é€šå¸¸å„²å­˜åœ¨data.frameä¸­ä½¿ç”¨
#POSIXlt: æ˜¯ä¸€å€‹åˆ—è¡¨ç‰©ä»¶ (list), åˆ†åˆ¥å„²å­˜ æ˜ŸæœŸä¸­çš„ç¬¬å¹¾å¤©, ä¸€å¹´ä¸­çš„ç¬¬å¹¾å¤©, æœˆä»½, æœˆä¸­çš„ç¬¬å¹¾å¤©ç­‰ç­‰. 

#{R} çš„æ—¥æœŸæ™‚é–“çš„å…§è¨­æœ‰äº›è¤‡é›œ, å› æ­¤ {R} æœ‰äº›å°ˆé–€æ—¥æœŸæ™‚é–“å¥—ä»¶
#ä¾‹å¦‚tidyverseå¥—ä»¶ç³»çµ±æä¾›lubridateå¥—ä»¶, æˆ–æ›´å®Œæ•´çš„è²¡å‹™é‡‘èRmetrics` å¥—ä»¶, é€™äº›å¥—ä»¶å¯ä»¥åœ¨è™•è£¡æ™‚é–“ä¸Šè®Šå¾—è¼ƒç‚ºæ–¹ä¾¿.

```

ğŸŒ» `as.POSIXct(x, format)` converts a string vector `x` into a `POSIXct` vector.<br> 

ğŸŒ· Watch how format of the time string is specified in Date and Time Codes (see Table-1 below)    

![Date and Time Formating Codes](fig/date_time.png){height=400}<br>
Table-1 Date and Time Formatting Codes

Now we can make histograms of this time variable (`ts`) in the same way as we do for numerics ...
```{r fig.height=2.5, fig.width=6.8}
par(mfrow=c(1,2), mar=c(4,3,3,1), cex=0.7)
hist(ts,"year",las=2,freq=T,xlab="",main="Event Counts in Years")
hist(ts,"quarter",las=2,freq=T,xlab="",main="Event Counts in Quartera")
```
<br><br>

ğŸŒ» `format()` can convert date/times back to strings in the desirable format

For examples, if we want to count the car thief events by weekdays ... 
```{r}
table( format(ts,'%w') )
```

by hours ...
```{r}
table( format(ts,'%H') )
```

by 7 days and 24 hours ...
```{r}
table(weekday=format(ts,'%u'), month=format(ts,'%H'))
```

With a few more line of codes we can transform the table into a heatmap that illustrates the time distribution of car thief events nicely. The plotting function will be elaborated latter in this course  
```{r fig.height=2.5, fig.width=6.8}
table(format(ts,"%u"), format(ts,"%H")) %>% 
  as.data.frame() %>% setNames(c("weekday","hour","count")) %>% 
  ggplot(aes(hour,weekday,fill=count)) +   #fill:ä¸Šè‰²
  geom_tile() + coord_fixed(ratio=1) +     #tile:ç†±åœ–ã€coord:å°æ–¹æ¡†
  scale_fill_gradientn(colors=c("seagreen","yellow","darkred"))
  #å¯å¸¶nç¨®é¡è‰²
```

<br><p class="wwl">
<span style="font-size:16px">ğŸ’¡ Hints:</span>
The most useful functions in R are ...<br>
&emsp; â–  `table()`<br>
&emsp; â–  `tapply()`<br>
incorporating with ...<br>
&emsp; â–  `sort()`, `head()`, `tail()`<br>
&emsp; â–  `sum()`, `mean`, `max()`, `min`<br>
You should be able to solve all fo the questions below<br>
</p class="wwl"><br>

ã€2.2ã€‘ What is the month and year of the **median** date in our dataset? 
```{r}
format(median((ts)),'%m')
format(median((ts)),'%Y')
```

ã€2.3ã€‘ In which month did the fewest motor vehicle thefts occur?
```{r}
min(table(format(ts,'%m')))
x=(table(format(ts,'%m')))
x
names(x)[x==min(x)]
```

ã€2.4ã€‘ On which weekday did the most motor vehicle thefts occur?
```{r}
table(format(ts,'%u'))
y = table(format(ts,'%u'))
names(y)[y==max(y)]
```

ã€2.5ã€‘ Which month has the largest number of motor vehicle thefts for which an arrest was made?
```{r}
max(table(format(ts,'%m'),D$Arrest)[,2])
z = table(format(ts,'%m'),D$Arrest)[,2]
names(z)[z==max(z)]

table( format(ts[D$Arrest %in% TRUE],'%m'))

```
<br><br>


### Section-3 Visualizing Crime Trends

ã€3.1ã€‘ In general ... 

+ does it look like crime increases or decreases from 2002 - 2012? 
+ does it look like crime increases or decreases from 2005 - 2008? 
+ does it look like crime increases or decreases from 2009 - 2011?
```{r}
par(mfrow=c(2,2), mar=c(4,3,3,1), cex=0.7)

# 2002å¹´åˆ°2012å¹´é€å¹´çš„çŠ¯ç½ªæ•¸
subset(ts, format(ts, '%Y') >= 2002 & format(ts, '%Y') <= 2012) %>%
  hist("year",las=2,freq=T,xlab="",main="Event Counts in 2002 ~ 2012")
# é€å¹´æ¸›å°‘ï¼Œä½†åœ¨2010å¹´å’Œ2011å¹´æœ‰å›å‡çš„è¶¨å‹¢

# 2005å¹´åˆ°2008å¹´é€å¹´çš„çŠ¯ç½ªæ•¸
subset(ts, format(ts, '%Y') >= 2005 & format(ts, '%Y') <= 2008) %>%
  hist("year",las=2,freq=T,xlab="",main="Event Counts in 2005 ~ 2008")
# é€å¹´ä¸‹é™çš„è¶¨å‹¢

# 2009å¹´åˆ°2011å¹´é€å¹´çš„çŠ¯ç½ªæ•¸
subset(ts, format(ts, '%Y') >= 2009 & format(ts, '%Y') <= 2011) %>%
  hist("year",las=2,freq=T,xlab="",main="Event Counts in 2009 ~ 2011")
# é€å¹´æå‡çš„è¶¨å‹¢ï¼Œå¯èƒ½è·Ÿé‡‘èé¢¨æš´æœ‰é—œ
```

ã€3.2ã€‘ Does it look like there were more crimes for which arrests were made in the first half of the time period or the second half of the time period?
```{r}
# åœ¨å‰åŠæ™‚æ®µé‚„æ˜¯å¾ŒåŠæ™‚æ®µç ´æ¡ˆæ•¸è¼ƒå¤š
table(format(subset(ts, D$Arrest == T), '%Y') >= 2007)
table(format(subset(ts, D$Arrest == T), '%Y') >= 2006)
table(format(subset(ts, D$Arrest == T), '%Y'))
# å‰åŠæ™‚æ®µç ´æ¡ˆæ•¸è¼ƒå¤š
```

ã€3.3ã€‘ For what proportion of motor vehicle thefts in 2001 was an arrest made?
```{r}
prop.table(table(D$Arrest,format(ts,'%Y')),2)
v = table(D$Arrest,format(ts,'%Y')) %>% prop.table(2)
v
v['TRUE','2001']
```

ã€3.4ã€‘ For what proportion of motor vehicle thefts in 2007 was an arrest made?
```{r}
# 2007å¹´çš„äº‹ä»¶ç ´æ¡ˆç‡
tapply(D$Arrest, format(ts, '%Y'), mean)["2007"]
```

ã€3.5ã€‘ For what proportion of motor vehicle thefts in 2012 was an arrest made?
```{r}
# 2012å¹´çš„äº‹ä»¶ç ´æ¡ˆç‡
tapply(D$Arrest, format(ts, '%Y'), mean)["2012"]
tapply(D$Arrest, format(ts, '%Y'), mean)
```

<br><br>


### Section-4 Popular Locations

ã€4.1ã€‘ Which locations are the top five locations for motor vehicle thefts, excluding the "Other" category? You should select 5 of the following options.

```{r}
subset(D, D$LocationDescription != "OTHER", c("LocationDescription")) %>%
  table() %>% sort() %>% tail(5) %>% names()

n = tail(sort(table(subset(D,D$LocationDescription!='OTHER', c("LocationDescription")))),5)

class(n)
n
names(n)

#subset(D, D$LocationDescription != "OTHER")
```

ã€4.2ã€‘ How many observations are in Top5?
```{r}
# å‰äº”åäº‹ä»¶ç™¼ç”Ÿçš„åœ°é»ç¸½å…±ç™¼ç”Ÿå¹¾ä»¶
subset(D, D$LocationDescription != "OTHER", c("LocationDescription")) %>%
  table() %>% sort() %>% tail(5) %>% sum()

sum(n)

```

ã€4.3ã€‘ One of the locations has a much higher arrest rate than the other locations. Which is it? 
```{r}
# ç ´æ¡ˆç‡æœ€é«˜çš„æ¡ˆç™¼åœ°é»
tapply(D$Arrest, D$LocationDescription, mean) %>% sort() %>% tail(1) %>% names()
```

ã€4.4ã€‘ On which day of the week do the most motor vehicle thefts at gas stations happen?
```{r}
# æ˜ŸæœŸå¹¾ç™¼ç”Ÿåœ¨åŠ æ²¹ç«™çš„äº‹ä»¶æœ€å¤š
subset(ts, D$LocationDescription == "GAS STATION") %>% format('%u') %>% table() %>% 
  sort() %>% tail(1) %>% names()
```

ã€4.5ã€‘ On which day of the week do the fewest motor vehicle thefts in residential driveways happen?
```{r}
# æ˜ŸæœŸå¹¾ç™¼ç”Ÿåœ¨ä½å®…è»Šé“çš„äº‹ä»¶æœ€å°‘
subset(ts, D$LocationDescription == "DRIVEWAY - RESIDENTIAL") %>% format('%u') %>% table() %>% 
  sort() %>% head(1) %>% names()
```

<br><br>

<center>
![](../etc/ninja1.jpg){height=80}

##### NINJA's DOJO â— â— â—
</center>

```{r fig.height=5.5}
L6 = table(D$Loc) %>% sort %>% tail() 
D %>% mutate(ts = ts) %>% 
  filter(LocationDescription %in% names(L6)[-4]) %>% 
  mutate(Loc = str_remove(LocationDescription, " .*$")) %>% 
  group_by(Loc, wday=format(ts,"%u"), hour=format(ts,"%H")) %>% 
  summarise(no.events = n(), arrest.rate = mean(Arrest), .groups="drop") %>% 
  group_by(Loc) %>% mutate_at(vars(no.events,arrest.rate), scale) %>% 
  gather("key","value",4:5) %>% 
  ggplot(aes(x=hour, y=wday,fill=value)) + geom_tile(alpha=0.75) +
  scale_fill_gradientn(colors=c("darkgreen","green","yellow","red","darkred")) +
  coord_fixed(ratio=1) + facet_grid(Loc~key) + theme_bw() +
  theme(axis.ticks=element_blank(),axis.text=element_text(size=6)) +
  ggtitle("Vehical Crimes in a Week")
```

<br><p class="wwl">
<span style="font-size:18px">`r "\U1F4A1"` ç­–ç•¥æ„æ¶µï¼š</span><br>
&emsp; â™ å¦‚æœä½ æ˜¯è­¦æ–¹ï¼Œä½ è¦å¦‚ä½•é…ç½®è­¦åŠ›ï¼Ÿ<br>
&emsp; â™ é‚£å¦‚æœä½ æ˜¯å°å·å‘¢ï¼Ÿ<br>
</p class="wwl"><br>

ğŸŒ· å…‰æ˜¯ä½¿ç”¨`table()`å’Œ`tapply()`å’Œè³‡æ–™è¦–è¦ºåŒ–ï¼Œ
æˆ‘å€‘å°±å·²ç¶“å¯ä»¥å¾è³‡æ–™ä¸­æ‰¾åˆ°è¨±å¤šæœ‰ç­–ç•¥æ„æ¶µçš„è³‡è¨Šäº†ã€‚

<br><br>