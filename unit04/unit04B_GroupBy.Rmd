---
title: UNIT4Bï¼šdplyrè³‡æ–™ç¾¤çµ„èˆ‡ç¾¤çµ„é‹ç®—
author: ä¸­å±±å¤§å­¸ç®¡ç†å­¸é™¢ å“é›ç„¶, NSYSU
date: "`r Sys.time()`"
output: 
  html_document: 
    css: ../etc/style.css
    highlight: pygments
    theme: spacelab
editor_options: 
  chunk_output_type: console
---

```{r echo=F, results='hide', message=FALSE, warning=FALSE}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.7) 
options(scipen=20, digits=4, width=80, tibble.print_min=4)
rmarkdown::find_pandoc(version = '2.7.3')
if(!require(pacman)) install.packages("pacman")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(plotly)) install.packages("plotly")
```

<br><br><p class="wwl"><span style='font-size:24px'> ğŸ  </span>
<span style='font-size:14px; font-family:"Arial Black"'>
<b><u>å­¸ç¿’é‡é» :</u></b></span><br>
å°ç…§ Datacamp ç¬¬å››ç« ï¼š [Data Manipulation with dplyr](https://learn.datacamp.com/courses/data-manipulation-with-dplyr) <br>
&emsp; â–  `group` åœ¨ dplyr çš„ä½œç”¨<br>
&emsp; â–  `group_by()` ... `summarise()`  <br>
&emsp; â–  `group_by()` ... `mutate()`  <br>
&emsp; â–  ä»‹ç´¹ä¸‰ç¨®ä¸åŒçš„ R åŠŸèƒ½ ... <br>
&emsp; &emsp; ã€‚ **åŒ¯ç¸½**åŠŸèƒ½ (summary functionsï¼Œä¾‹: `sum`, `mean`) æœƒå°‡å‘é‡è½‰ç‚ºå–®å€¼ <br>
&emsp; &emsp; ã€‚ **å‘é‡**åŠŸèƒ½ (vector functionsï¼Œä¾‹: `sqrt`, `log`) æœƒå°‡å‘é‡è½‰ç‚ºç­‰é•·çš„å‘é‡ <br>
&emsp; &emsp; ã€‚ **çª—å£**åŠŸèƒ½ (window functionsï¼Œä¾‹: `order`, `lag`) æœƒå°‡å‘é‡è½‰ç‚ºç­‰é•·çš„å‘é‡ <z>ä½† ... </z><br>
&emsp; â–  ä»‹ç´¹ `ggplot2` : `dplyr` çš„å§å¦¹å¥—ä»¶  <br>
</p class="wwl">

![](fig/GroupOp.png){width=600}

<br><br>


è¼‰å…¥æ‰€éœ€å¥—ä»¶ & è®€å– babynames è³‡æ–™é›† 
```{r message=FALSE, warning=FALSE}
pacman::p_load(dplyr,tidyr,ggplot2,babynames)
B = babynames
B
```

é€™æ˜¯å°ç¾åœ‹å‡ºç”Ÿå¬°å…’å§“åçš„çµ±è¨ˆè³‡æ–™ï¼Œæœé›†äº†1880å¹´å¾Œæ¯ä¸€å¹´ã€æ¯ä¸€å€‹å¬°å…’åå­—çš„ç™»è¨˜æ¬¡æ•¸ã€‚æ˜¯ä¸€å€‹ç›¸ç•¶å¤§çš„è³‡æ–™é›†ï¼Œå…±æœ‰`1,924,665`ç­†ç´€éŒ„èˆ‡5å€‹æ¬„ä½ ...   

```{r}
str(B)
```

<br><br>

### 1. Group_By

ğŸŒ» `group_by()` åœ¨è³‡æ–™æ¡†(tibbles)ä¸­æ¨™æ³¨ç¾¤<z>çµ„çµæ§‹</z>(`Groups`)ï¼Œ
çµ„çµæ§‹æœ¬èº«ä¸æœƒæ”¹è®Šè³‡æ–™ï¼Œä½†æœƒå½±éŸ¿è³‡æ–™è™•ç†ç®¡ç·š(`%>%`)ä¹‹ä¸­å¾ŒçºŒåŠŸèƒ½çš„é‹ä½œæ–¹å¼ã€‚

```{r}
B
group_by(B, year)

```
<br>

â“ æ¯”è¼ƒä¸Šé¢å…©æ®µç¨‹å¼ï¼Œä»–å€‘æœ‰ä»€éº¼ä¸ä¸€æ¨£å—ï¼Ÿ 

<br>
```{r}
# Groups: year [138]  å‰è€…ç„¡åˆ†çµ„å¾Œè€…æœ‰

```

<br>


### 2. Group Summaries

`group_by()` æŒ‡ä»¤å¾Œé¢æœ€å¸¸æ¥çš„å‡½æ•¸ç‚º `summarise()`. 
```{r}
group_by(B, year) %>% summarise(
  no_records = n(),               # å„å¹´ä»½çš„è³‡æ–™ç­†æ•¸
  no.names = n_distinct(name),    # å„å¹´ä»½å‡ºç¾å¹¾ç¨®ä¸åŒçš„åå­—
  no.baby = sum(n)                # å„å¹´ä»½çš„å¬°å…’æ•¸é‡ 
  )
```

ğŸŒ» `group_by() %>% summarise()` : ç”±æ–¼`summarise()`ä¹‹ä¸­åªèƒ½ç”¨å›å‚³å–®å€¼çš„é‹ç®—å¼ä¾†å®šç¾©æ–°è®Šæ•¸
(é€šå¸¸æ˜¯ä½¿ç”¨åƒ`mean()`,`max()`,`n()`é€™ä¸€é¡çš„summary functions)ï¼Œ
æ‰€ä»¥åŸ·è¡Œå®Œ`summarise()`ä¹‹å¾Œï¼Œæ¯å€‹çµ„çµæ§‹æœƒè¢«å½™ç¸½æˆä¸€ç­†è³‡æ–™ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œé€™å€‹ç¾¤çµ„çµæ§‹å°±æ²’æœ‰ç”¨äº†ï¼Œå› æ­¤æ¯ä¸€æ¬¡åŸ·è¡Œå®Œ`summarise()`ä¹‹å¾Œï¼Œè³‡æ–™æ¡†ä¹‹ä¸­çš„æœ€å¾Œä¸€å€‹çµ„çµæ§‹å°±æœƒè¢«ç§»é™¤ã€‚ç”±æ–¼å®ƒåªæœƒè‡ªå‹•ç§»é™¤æœ€å¾Œä¸€å€‹çµ„çµæ§‹ï¼Œæ‰€ä»¥å¦‚æœä½ åœ¨`group_by()`è£¡é¢ä¸€æ¬¡æ”¾å¾ˆå¤šå€‹ç¾¤çµ„è®Šæ•¸ï¼Œ`summarise()`ä¹‹å¾Œè³‡æ–™æ¡†ä¹‹ä¸­å°±æœƒæœ‰ä¸€äº›æ®˜ç•™ä¸‹ä¾†çš„çµ„çµæ§‹ï¼Œå‡å¦‚ä½ ä¸å†éœ€è¦é€™ä¸€äº›çµæ§‹ï¼Œæœ€å¥½åœ¨è³‡æ–™è™•ç†ç®¡ç·šä¹‹ä¸­ç”¨`ungroup()`æˆ–è€…åœ¨`summarise()`è£¡é¢ç”¨`.groups='drop'`å°‡å®ƒå€‘ç§»é™¤ï¼Œä»¥å…é€ æˆéŒ¯èª¤æˆ–è€…æ‹–æ…¢ç®¡ç·šåŸ·è¡Œçš„é€Ÿåº¦ã€‚

<br><br>


### 3. Group Mutate

Group mutate æ¯” group summarise æ›´æœ‰ç”¨ï¼Œä½†è¦å®ƒç”¨éœ€è¦æ³¨æ„æ¯”è¼ƒå¤šçš„ç´°ç¯€ï¼

##### 3.1 ç´”å‘é‡é‹ç®— (Pure Vector Operations)

ğŸŒ» åœ¨ç¾¤çµ„çµæ§‹ä¹‹ä¸­ï¼Œ`mutate()`è£¡é¢åªå…è¨±ä½¿ç”¨æœƒå›å‚³è·Ÿç¾¤çµ„è³‡æ–™ç­‰é•·å‘é‡çš„é‹ç®—å¼ 
 
ğŸŒ· ä½†æ˜¯å¦‚æœé‹ç®—å¼ä¸­åªç”¨åˆ° vector functions æˆ–è€…æ˜¯æ•¸å­¸é‹ç®—ç¬¦è™Ÿï¼Œåƒé€™æ¨£å­å–®ç´”çš„å‘é‡é‹ç®—ï¼Œä¸¦ä¸éœ€è¦ç”¨åˆ°ç¾¤çµ„çµæ§‹ï¼Œå–®ç´”çš„å‘é‡é‹ç®—åœ¨æ•´å€‹è³‡æ–™æ¡†åŸ·è¡Œæœƒæ¯”è¼ƒæœ‰æ•ˆç‡ï¼›å–®ç´”çš„å‘é‡é‹ç®—ç›´æ¥åœ¨æ•´å€‹è³‡æ–™æ¡†åšå’Œåœ¨çµ„çµæ§‹è£¡é¢åšçš„çµæœæ˜¯ä¸€æ¨£çš„ï¼Œåœ¨çµ„çµæ§‹è£¡é¢åšç´”å‘é‡é‹ç®—æœƒæ‹–æ…¢è³‡æ–™ç®¡ç·šçš„é‹ç®—é€Ÿåº¦ï¼Œå»ä¸èƒ½å¾—åˆ°ä»»ä½•å¥½è™•ã€‚

```{r}
B %>% group_by(name) %>% mutate(logN=log(n), sqrtN=sqrt(n))
```
é€™å€‹Group Mutateæœƒåœ¨æ¯ä¸€å€‹çµ„çµæ§‹è£¡é¢åšä¸€æ¬¡é‹ç®—ï¼Œæ‰€ä»¥é€™ä¸€æ®µç¨‹å¼ç¸½å…±æœƒåŸ·è¡Œ97,310 æ¬¡ï¼Œ

ä½†å…¶çµæœå»å’Œ...
```{r}
B %>% mutate(logN=log(n), sqrtN=sqrt(n))
```
å°æ•´å€‹tibbleåªåšä¸€æ¬¡å‘é‡é‹ç®—çµæœå®Œå…¨ç›¸åŒ

ğŸŒ· æ‰€ä»¥ï¼Œç›´è¦ºä¸Šgroup mutateå¥½åƒæ˜¯å…©ç›¸çŸ›ç›¾çš„ ...

+ ä¸€æ–¹é¢ï¼Œ`mutate()`è£¡é¢åªå…è¨±ä½¿ç”¨å‘é‡é‹ç®—å¼
+ å¦ä¸€æ–¹é¢ï¼Œå°ç´”å‘é‡é‹ç®—é€²è¡Œgroup mutateå»æ˜¯æ²’æœ‰æ„ç¾©çš„
+ ç„¶è€Œï¼Œgroup mutateå…¶å¯¦æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæˆ‘å€‘å°‡åœ¨ä¸‹é¢æåˆ°å®ƒçš„æ­£ç¢ºä½¿ç”¨æ–¹æ³•

<br>


##### 3.2 ä½¿ç”¨SummaryåŠŸèƒ½çš„å‘é‡é‹ç®—å¼(Vector Expression)
å¯¦éš›ä¸Šï¼Œåœ¨ `mutate()`ä¸­ï¼Œé™¤äº†å‘é‡å‡½æ•¸ä¹‹å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨å‘é‡é‹ç®—å¼ä¾†å®šç¾©æ–°æ¬„ä½ï¼Œåªè¦é‹ç®—å¼æ‰€ç”¢ç”Ÿçš„å‘é‡é•·åº¦èˆ‡Groupçš„é•·åº¦ç›¸åŒå°±å¯ä»¥ã€‚ ä¾‹å¦‚ï¼Œæˆ‘å€‘æœ‰æ™‚å€™æœƒæƒ³è¦å°‡æ•¸å€¼è½‰æ›æˆæ¯”ä¾‹ï¼Œä¾‹å¦‚ï¼Œæˆ‘å€‘æƒ³çŸ¥é“æŸå€‹åå­—åœ¨æŸå¹´å—æ­¡è¿çš„ç¨‹åº¦ï¼Œæˆ‘å€‘æ‡‰è©²è¦çœ‹çš„æ˜¯è©²åå­—åœ¨ç•¶å¹´åº¦çš„ä½”æ¯”ï¼Œè€Œä¸æ˜¯æ•¸é‡ã€‚ é€™å€‹å·¥ä½œå°±å¯ä»¥é€éä¸€å€‹å‘é‡é‹ç®—å¼ä¾†å®Œæˆï¼Œåƒåœ¨  ....
```{r}
group_by(B, year) %>% mutate(frac = 100*n/sum(n))
```
ä¹‹ä¸­`sum()` å¯ä»¥æ ¹æ“š `Groups: year [138]` çš„çµæ§‹ï¼Œç”¢ç”Ÿæ¯ä¸€å¹´æ‰€æœ‰`n`çš„ç¸½å’Œã€‚ ä»¥é€™å€‹æ–¹å¼
ï¼Œå‘é‡é‹ç®—å¼å°±æœƒå°æ¯ä¸€å¹´çš„æ‰€æœ‰åç¨±åšä¸€æ¬¡é‹ç®—ä¸¦ç”¢ç”Ÿæ¯å¹´æ¯å€‹åå­—çš„ç™¾åˆ†æ¯”

è«‹æ³¨æ„ï¼ŒåŸå§‹çš„è³‡æ–™é›†å·²ç¶“æœ‰ä¸€å€‹ `prop` çš„æ¬„ä½ (column)ï¼Œä½†é€™å€‹æ¬„ä½æ˜¯æŒ‰ç…§å¹´åˆ†å’Œæ€§åˆ¥åˆ†é–‹å»è¨ˆç®—çš„ï¼Œå› æ­¤`prop` å¤§ç´„æ˜¯ `frac` çš„å…©å€ã€‚

<br>

##### 3.3 Window åŠŸèƒ½
WindowsåŠŸèƒ½æ˜¯å‘é‡åŠŸèƒ½ä¸­çš„ä¸€ç¨®ç‰¹åˆ¥çš„é¡å‹ï¼Œå°±åƒä¸€èˆ¬çš„å‘é‡å‡½æ•¸ï¼Œå®ƒä¹Ÿæœƒå›å‚³ä¸€å€‹å’Œè¼¸å…¥ç›¸åŒé•·åº¦çš„å‘é‡ã€‚ ç„¶è€Œï¼Œå¤§éƒ¨åˆ†çš„å‘é‡åŠŸèƒ½çš„é‹ç®—çµæœéƒ½ä¸æœƒè¢« `Groups`çµæ§‹æ‰€å½±éŸ¿ï¼Œä½†æ˜¯windowsåŠŸèƒ½çš„é‹ç®—çµæœå»æœƒå–æ±ºæ–¼`Groups`ã€‚ 

Windows åŠŸèƒ½å¤§éƒ¨åˆ†éƒ½å’Œå‘é‡ä¸­å…ƒç´ çš„æ’åˆ—é †åºæœ‰é—œï¼Œä¾‹å¦‚ï¼š

+ `rank(v)`  ç”¢ç”Ÿä¸€å€‹åŸºæ–¼`v`çš„å€¼æ’åºçš„ç´¢å¼•å‘é‡,
+ `lag(v, n)`  å°‡å‘é‡å‘å‰ç§»å‹• `n` å€‹ä½ç½®  
+ `lead(v, n)` å°‡å‘é‡å‘å¾Œç§»å‹• `n` å€‹ä½ç½®  

èˆ‰ä¸€å€‹å¯¦éš›çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘å€‘æƒ³èª¿æŸ¥åå­—çš„æµè¡Œåº¦éš¨æ™‚é–“è®ŠåŒ–çš„é€Ÿåº¦ï¼Œæˆ‘å€‘å¯ä»¥...
```{r}
B %>% group_by(sex, name) %>%              
  arrange(year) %>%                # å…ˆå°‡è³‡æ–™æ ¹æ“šå¹´ä»½å‡å†ªæ’åº
  mutate(                          # ç„¶å¾Œä½¿ç”¨lagä¾†è¨ˆç®—
    delta = 100 * (prop-lag(prop)) # æ¯å¹´ prop å¢åŠ çš„ç™¾åˆ†æ¯”
    ) %>%                          # 
  arrange(desc(delta))             # æ ¹æ“šdeltaé™å†ªæ’åº
```
`prop` æ¬„ä½å¢åŠ æœ€å¤šçš„æ˜¯ 1947 å¹´å¥³ç”Ÿçš„åå­— Linda 

<br><br><br>


<center>
![](../etc/ninja1.jpg){height=80}
</center>

##### å¿è€…é“å ´ . . . . .
è®“æˆ‘å€‘ç”¨æˆ‘å€‘å­¸åˆ°çš„æ±è¥¿æ‡‰ç”¨åœ¨å¬°å…’å§“åè³‡æ–™é›†ä¸Šé¢ï¼Œä¸¦ä¸”é…åˆ`ggplot2`å’Œ`plotly`å¥—ä»¶åšäº’å‹•å¼çš„è³‡æ–™è¦–è¦ºåŒ–ã€‚

æ‰¾å‡ºå‰20åçš„åå­—ï¼Œä¸¦è¨ˆç®—å‡ºä»–å€‘çš„ç´¯è¨ˆç™¾åˆ†æ¯”
```{r}
count(B, sex, name, wt=n, sort=T) %>% 
  mutate(pc=n/sum(n), cumpc=cumsum(pc)) %>% 
  head(20)
```

å°‡æ›¾ç¶“æ˜¯å¹´åº¦æœ€å—æ­¡è¿çš„å¥³æ€§åå­—éƒ½æ‰¾å‡ºä¾†ï¼Œæ”¾åœ¨`fChamp`è£¡é¢ã€‚
```{r}
filter(B, sex=="F")  %>% 
  group_by(year) %>% top_n(1, n) %>% ungroup %>%  
  count(name, sort=T) -> fChamp
```

ä¸¦å°‡å®ƒå€‘æ¯ä¸€å¹´çš„ä½”æ¯”ç”¨æŠ˜ç·šåœ–ç¹ªè£½åœ¨äº’å‹•å¼çš„åœ–è¡¨ä¸­
```{r fig.height=3.5, fig.width=7}
gg = filter(B, sex=="F", name%in%fChamp$name) %>% 
  ggplot(aes(x=year, y=prop, color=name)) + geom_line() +
  labs(color="",title="æœ€å—æ­¡è¿çš„å¥³ç”Ÿåå­—")
ggplotly(gg) %>% layout(legend=list(tracegroupgap=4))
```

å°ç”·ç”Ÿåå­—ä¹ŸåšåŒæ¨£çš„äº‹æƒ…
```{r fig.height=3.5, fig.width=7}
filter(B, sex=="M")  %>% 
  group_by(year) %>% top_n(1, n) %>% ungroup %>%  
  count(name, sort=T) -> mChamp

gg = filter(B, sex=="M", name%in%mChamp$name) %>% 
  ggplot(aes(x=year, y=prop, color=name)) + geom_line()+
  labs(color="",title="æœ€å—æ­¡è¿çš„ç”·ç”Ÿåå­—")
ggplotly(gg) %>% layout(legend=list(tracegroupgap=4))
```


ğŸ„ é€™æ¬¡å¿è€…é“å ´ä¸­æˆ‘å€‘å¯ä»¥å­¸åˆ°å…©ä»¶äº‹......

+ `dplyr`çš„èªæ³•æ¯”è¼ƒå†—é•·ï¼Œä¸éå®ƒæ¯”è¼ƒæœ‰æ“´å……æ€§ï¼Œä¹Ÿæ¯”è¼ƒæ¸…æ¥šã€‚   
+ `dplyr`åŠ ä¸Š`ggplot`ï¼Œå¯ä»¥ç”¨æ¥æ°´ç®¡çš„æ–¹å¼ï¼Œé€éå¾ˆç²¾ç·»çš„åœ–è¡¨ï¼Œä½œäº’å‹•å¼çš„è³‡æ–™æ¢ç´¢ã€‚

<br><br><br><hr>

