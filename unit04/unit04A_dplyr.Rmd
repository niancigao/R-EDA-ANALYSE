---
title: UNIT4Aï¼šè³‡æ–™æ¡†è™•ç†å¥—ä»¶`dplyr`
author: Tony Chuo, NSYSU
date: "`r Sys.time()`"
output: 
  html_document: 
    css: ../etc/style.css
    highlight: pygments
    theme: spacelab
editor_options: 
  chunk_output_type: console
---

```{r echo=F, results='hide', message=FALSE, warning=FALSE}
# Installation, setup & formatting. Do not modify this code chunk.  
rm(list=ls(all=T))
knitr::opts_chunk$set(comment = NA)
knitr::opts_knit$set(global.par = TRUE)
par(cex=0.8); options(scipen=20, digits=4, width=90)
if(!require(pacman)) install.packages("pacman")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
if(!require(ggplot2)) install.packages("ggplot2")
options(scipen=20, digits=4, width=80, tibble.print_min=4)
rmarkdown::find_pandoc(version = '2.7.3')
```

<br>
<z>å­¸ç¿’é‡é»</z>ï¼šä½¿ç”¨`dplyr`å¥—ä»¶åšè³‡æ–™æ¡†æ•´ç†
<br>

è¼‰å…¥å¥—ä»¶èˆ‡è³‡æ–™
```{r message=FALSE, warning=FALSE}
pacman::p_load(dplyr,tidyr,ggplot2)
D = readRDS('data/counties.rds')
```
<br>

### 1. è³‡æ–™è½‰æ› 
```{r}
class(D)  # åˆ—å‡ºç‰©ä»¶çš„è³‡æ–™çµæ§‹
```
`tbl_df` å¯ä»¥çœ‹æˆåŠ å¼·ç‰ˆçš„ `data_frmae`ï¼›åŸæœ‰è³‡æ–™æ¡†çš„æ“ä½œä¹‹å¤–ï¼Œå®ƒæœ‰ä¸€äº›é™„åŠ çš„åŠŸèƒ½ 

ğŸŒ» <z>`glimpse`</z>  åŠ å¼·ç‰ˆçš„`str`
```{r}
glimpse(D)
str(D)

```

ğŸŒ `D` : å…¨ç¾åœ‹3,138å€‹éƒ¡(county)çš„çµ±è¨ˆè³‡æ–™

ğŸŒ» <z>`select()`</z>  é¸æ“‡æ¬„ä½(è®Šæ•¸) 
```{r}
D %>% select(state,county,population,unemployment)
```

```{r}
D1 = D %>% select(state,county,population,unemployment)
```

ğŸŒ» <z>`arrange()`</z>  é‡æ–°æ’åˆ—è³‡æ–™(rows) 
```{r}
D1 %>% arrange(population) %>% head
# D1[order(D1$population),] %>% head
```

```{r}
D1 %>% arrange(desc(population)) %>% head   # é™å†ªæ’åˆ—
# D1[order(-D1$population),] %>% head
```

<br>
â“ è«‹åˆ—èˆ‰é€™å¹¾å€‹åŠŸèƒ½çš„ä¸»è¦ç•°åŒ `sort()`, `order()` and `arrange()`?  
<br>
```{r}

#sortæ˜¯ç›´æ¥å°å‘é‡æ’åºï¼Œè¿”å›åŸæ•¸å€¼

#orderå…ˆå°æ•¸å€¼æ’åºï¼Œç„¶å¾Œè¿”å›æ’åºå¾Œå„æ•¸å€¼çš„ç´¢å¼•
#orderç­‰åŒæ–¼sort(data)æ’åº

#arrangeæ˜¯dplyråŒ…ä¸­çš„ï¼Œé‡å°æ•¸æ“šæ¡†æŒ‰åˆ—æ’åºï¼Œä»è¿”å›æ•¸æ“šæ¡†

```

ğŸŒ» <z>`filter()`</z>  ç¯©é¸è³‡æ–™
```{r}
D1 %>% 
  filter(state == "New York", unemployment < 8) %>% 
  arrange(desc(population))
```

ğŸŒ» <z>`mutate()`</z> : å®šç¾©æ–°æ¬„ä½
```{r}
D1 %>% 
  mutate(unempRate = 100 * unemployment/population) %>%
  arrange(desc(unempRate)) %>% 
  head(4)
```

ä»¥ä¸Šçš„é€™äº›åŠŸèƒ½ç”¨æˆ‘å€‘å·²ç¶“å­¸éçš„Rå…§å»ºåŠŸèƒ½(é…åˆç´¢å¼•)ä¹Ÿéƒ½åšå¾—åˆ°ï¼Œæ‰€ä»¥ç‚ºä»€éº¼é‚„è¦å­¸`dplyr`å‘¢ï¼Ÿ ğŸ¤” <br>

ğŸŒ `dplyr`çš„å¥½è™•åœ¨æ–¼:

+ è·Ÿäººé¡èªè¨€(è‹±æ–‡)æ¯”è¼ƒæ¥è¿‘
+ å¯ä»¥ä¸€æ¬¡ç”¢ç”Ÿæˆ–è€…é¸æ“‡å¾ˆå¤šå€‹è®Šæ•¸ 
+ ä¹Ÿå¯ä»¥ä¸€æ¬¡ä½¿ç”¨å¾ˆå¤šå€‹æ¢ä»¶åšæ’åºæˆ–è€…ç¯©é¸
+ å¾ˆæ–¹ä¾¿é…åˆ`%>%`ä½¿ç”¨ï¼Œåšå‡ºæ¯”è¼ƒè¤‡é›œæˆ–è€…æ­¥é©Ÿæ¯”è¼ƒå¤šçš„è³‡æ–™è£é…ç·š 

<br><br>

### 2. è³‡æ–™å½™ç¸½

ğŸŒ» <z>`count()`</z>  åˆ†é¡è¨ˆç®—æ•¸é‡æˆ–åŠ ç¸½ 
```{r}
count(D)             # ç¸½è³‡æ–™ç­†æ•¸
```

```{r}
count(D, state)      # å„å·çš„è³‡æ–™ç­†æ•¸ No. Counties (tibbleè³‡æ–™æ¡†)
# table(D$state) (è³‡æ–™æ¡†è®Šå‘é‡)
```

`count()` å¯ä»¥èªªæ˜¯åŠ å¼·ç‰ˆçš„ `table()`
```{r}
D %>% count(state, wt=population, sort=T)

# wt = sum
# sort=T ç”±å¤§åˆ°å°

```
With the `wt` and `sort` arguments, it can 

+ sums `population` by `state`'s
+ and sorts the results in descending order

in a single line of code. <br>

ğŸŒ» <z>`summarise()`</z> è³‡æ–™å½™ç¸½ï¼Œå¯ä»¥ä¸€æ¬¡å®šç¾©å¾ˆå¤šå€‹å½™ç¸½å€¼ï¼Œ
```{r}
D %>% summarise(
  totalPop = sum(population),
  avgPop = mean(population)
  )
# sum(D$population)
# mean(D$population)
```

+ ç­‰è™Ÿçš„å³é‚Šå¿…é ˆè¦æ˜¯ä¸€å€‹å–®å€¼(ç®—å‡ºå–®å€¼çš„é‹ç®—å¼).  

ğŸŒ» <z>`group_by() %>% summarise()`</z> åˆ†é¡(ç¾¤)å½™ç¸½ 
```{r}
D1 %>% group_by(state) %>% summarise(
  totalPop = sum(population),
  avgPop = mean(population)
  ) %>% 
  arrange(desc(avgPop))

```
<br>

â“ æˆ‘å€‘ä¹‹å‰æœ‰å­¸éç”¨ tapply()` åšåˆ†ç¾¤é‹ç®—ï¼Œè·Ÿç›¸æ¯”è¼ƒ `group_by() %>% summarise()`æœ‰ç”šéº¼å¥½è™•å‘¢?  <br>
```{r}
#group_by()å‡½æ•¸é‹è¡Œçš„ç»“æœæ˜¯ä¸€å€‹tibbleå°è±¡ã€‚æˆ‘å€‘å¯ä»¥å°é‹è¡Œç»“æœç¹¼çºŒé€²è¡Œå…¶ä»–çš„æ•¸æ“šæ“ä½œã€‚ç»“åˆä½¿ç”¨ %>% summarise()ï¼Œä»£ç¢¼çš„å¯è®€æ€§ä¹Ÿéå¸¸å¥½

#tapply()ç”±factorçµ¦å‡ºçš„å‘é‡å­é›†è¦å†è‡ªå·±è½‰æˆè³‡æ–™æ¡†ï¼Œä¸égroup_byè¦æ›å‹æ…‹å°±æ²’tapply()å®¹æ˜“äº†

```

è·Ÿ `tapply()` ä¸€æ¨£ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä¸€æ¬¡ `group_by` å¾ˆå¤šå€‹åˆ†ç¾¤è®Šæ•¸ 
```{r}
D %>% group_by(state, metro) %>% summarise(
  totalPop = sum(population),
  avgPop = mean(population)
  ) %>% 
  arrange(desc(avgPop))

#group_by()æ”¹è®Šçµæ§‹(97ç­†è¨˜éŒ„é‚„æ˜¯50ç¾¤)ä¸æ”¹è®Šå…§å®¹
```

ğŸŒ· ä½†æ˜¯ ...

+ æ¯ä¸€æ¬¡ `summarise()` åªæœƒè‡ªå‹•å»é™¤<z>æœ€å¾Œä¸€å€‹</z>åˆ†ç¾¤è®Šæ•¸
+ æ®˜ç•™çš„åˆ†ç¾¤è®Šæ•¸æœ‰æ™‚å¯ä»¥ç¹¼çºŒä½¿ç”¨ï¼Œæœ‰æ™‚å¯èƒ½æœƒå¸¶ä¾†éº»ç…©
+ ä¸å†éœ€è¦çš„åˆ†ç¾¤è®Šæ•¸æœ€å¥½ç”¨ `.groups="drop"` å»é™¤æ‰

<br>

ğŸŒ»  <z>`top_n(x, n, wt)`</z> select the `top-n` rows by `wt` from `x`
```{r}
# select from D1 the three rows that has the largest populations 
D1 %>% top_n(n=3, wt=population)
```

```{r}
# select from each `state` the three rows that has the largest populations 
group_by(D1, state) %>% top_n(3, population)
```

â“ ä¸Šé¢å…©æ®µç¨‹å¼çš„å·®åˆ¥åœ¨å“ªè£¡å‘¢ï¼Ÿ
<br>
```{r}
#ç¬¬ä¸€å€‹æ˜¯åœ¨D1ä¸­æŠ“å‰ä¸‰å€‹æœ€å¤šäººæ•¸çš„è¡Œ
#ç¬¬äºŒå€‹æ˜¯åœ¨åˆ†æˆ50å·çš„æƒ…æ³ä¸‹å„æŠ“å‰ä¸‰å€‹æœ€å¤šäººæ•¸çš„éƒ¡

```
<br><br>

### 3. æ›´éˆæ´»çš„èªæ³• Select, Transmute and Rename 

`select()` å¯ä»¥é¸æ“‡ä¸€å€‹<z>ç¯„åœ</z>çš„æ¬„ä½
```{r}
D %>% select(state, county, drive:work_at_home)
```

ä¹Ÿå¯ä»¥ç”¨å­—ä¸²æ¯”å°åšé¸æ“‡ï¼Œå¦‚ `starts_with`, `ends_with` or `contains` 
```{r}
D %>% select(state, county, contains("work"))
# D %>% select(state, county, starts_with("work"))
```

ä¹Ÿå¯ä»¥åˆªå»æŸäº›æ¬„ä½
```{r}
D %>% select(-contains("work")) %>% ncol
```

`names()` åˆ—å‡ºæ‰€æœ‰æ¬„ä½åç¨± 
```{r}
names(D1)
```

ğŸŒ» <z>`rename()`</z> è®Šæ›´æ¬„ä½åç¨±
```{r}
D1 %>% rename(unemp = unemployment) %>% head(3)
```

`select()`å¯ä»¥åŒæ™‚å°å¤šå€‹æ¬„ä½åšé¸æ“‡ã€æ’åºå’Œè®Šæ›´åç¨±
```{r}
D1 %>% select(state, county, unemp = unemployment, population) %>% head(3)
```

ğŸŒ» <z>`transmute()`</z>  çµåˆ`select()`å’Œ`mutate()`çš„åŠŸèƒ½ï¼Œå¯ä»¥åŒæ™‚åšæ¬„ä½é¸æ“‡å’Œå®šç¾©æ–°æ¬„ä½
```{r}
D %>% transmute(state, county, fracM = men/population)
```

å››å€‹æ¬„ä½åŠŸèƒ½çš„æ¯”è¼ƒ
```{r}
data.frame(
  function_name = c("select()","mutate()","rename()","transmute()"),
  unselected_columns = c("removed","reserved","reserved","removed"),
  make_new_columns = c("no","yes","no","yes")
  )
```

<br><br><hr>


