---
title: TF_æœŸä¸­æœŸæœ« 
author: å“é›ç„¶,é«˜å¿µæ…ˆ, ä¸­å±±å¤§å­¸ ç®¡ç†å­¸è¡“ç ”ç©¶ä¸­å¿ƒ
date: "`r Sys.time()`"
output:
  html_document:
    highlight: pygments
    theme: flatly
    css: ../etc/style.css
---
<br>

### è³‡æ–™å½™æ•´æµç¨‹

<center>
![Fig-1:äº¤æ˜“è³‡æ–™å½™æ•´](fig/aggregation.jpg)
</center>

<hr>

### 1. äº¤æ˜“é …ç›®è¨ˆéŒ„ï¼š`Z`

```{r echo=T, message=F, cache=F, warning=F}

# é¡§å®¢æ•¸(A0)ã€äº¤æ˜“ç­†æ•¸(X0)ã€è³‡æ–™é …æ•¸(Z0)

#rm(list=ls(all=T))
#pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd)
pacman::p_load(magrittr, readr, caTools, ggplot2, dplyr, vcd, scales, Hmisc, foreign,lubridate, plotly, gridExtra)
```

##### 1.1 è®€é€²è³‡æ–™
```{r}
Z = read_csv("data/ta_feng_all_months_merged.csv") %>% 
  data.frame %>% setNames(c(
    "date","cust","age","area","cat","prod","qty","cost","price"))
nrow(Z)

#date:äº¤æ˜“è³‡æ–™ã€cust:é¡§å®¢IDã€age:å¹´é½¡æ—ç¾¤ã€area:å€åŸŸä»£ç¢¼
#cat:ç”¢å“å­é¡ã€prod:ç”¢å“ä»£ç¢¼ã€qty:æ•¸é‡ã€cost:è³‡ç”¢ã€price:éŠ·å”®åƒ¹æ ¼

#å°‡è³‡æ–™å¥—é€²å…¬å¼read_csv()è®€è³‡æ–™
#å†ä»¥data.frameå„²å­˜é¡ä¼¼ Excel è¡¨æ ¼çš„è®Šæ•¸é¡å‹
#ä¾æ“šäº¤æ˜“æ—¥æœŸã€é¡§å®¢IDã€é¡§å®¢å¹´é½¡ã€é¡§å®¢å±…ä½åœ°å€ã€äº¤æ˜“é …ç›®(ç¸½)æ•¸
#äº¤æ˜“é …ç›®(ç¸½)æ•¸ã€ç”¢å“(ç¸½)ä»¶æ•¸ã€äº¤æ˜“(ç¸½)é‡‘é¡ã€æ¯›åˆ©ç‚º data frame çš„åˆ—å‘½åã€‚
# æ‰¾å‡ºé …ç›®æ¯”æ•¸ï¼817741

```

##### æ—¥æœŸæ ¼å¼è½‰æ›
```{r fig.height=3.2, fig.width=7}
Z$date = as.Date(Z$date, format="%m/%d/%Y")
par(cex=0.8)
hist(Z$date,'weeks',freq=T,las=2)

#las=2åæ¨™è»¸åˆ»åº¦å‚ç›´æ–¼åæ¨™è»¸ã€‚

#as.Date(Z$date, format="%m/%d/%Y")ç”¨ä¾†æŠ“å–æœˆä»½ã€æ—¥ã€å¹´ã€‚
#par()ç”Ÿæˆä¸€å€‹å«æœ‰ç•¶å‰åœ–å½¢åƒæ•¸è¨­ç½®çš„åˆ—è¡¨ã€‚cexï¼æ§åˆ¶æ–‡å­—å’Œç¹ªåœ–ç¬¦è™Ÿçš„å¤§å°ï¼Œä¸€èˆ¬å¤§å°çš„80%ã€‚
#ç¹ªå‡ºç›´æ–¹åœ–ï¼Œxè»¸ï¼ä»¥é€±ç‚ºå–®ä½ï¼Œyè»¸ï¼è¨‚å–®æ•¸ã€‚mainï¼å„é€±è¨‚å–®æ•¸ã€‚

```

##### å¹´é½¡å±¤ç´šã€éƒµéå€è™Ÿ
```{r}
#å¹´é½¡ç´šå±¤å’Œéƒµéå€è™Ÿ
age.group = c("<25","25-29","30-34","35-39","40-44",
              "45-49","50-54","55-59","60-64",">65")
Z$age = c(paste0("a",seq(24,69,5)),"a99")[match(Z$age,age.group,11)]

# matchåœ¨ç¬¬äºŒå€‹åƒæ•¸ä¸­è¿”å›å…¶ç¬¬ä¸€å€‹åƒæ•¸çš„ï¼ˆç¬¬ä¸€å€‹ï¼‰åŒ¹é…ä½ç½®çš„å‘é‡
#ä¾‹: dict <- c('a', 'b', 'c', 'd', 'e')
#    ref <- c('a', 'e', 'hello')
#    match(ref, dict, 15)               ç­”: 1,5,15


# a99 ç„¡å¹´é½¡è³‡æ–™çš„(ä¸åœ¨ç¯„åœè£¡)

Z$area = paste0("z",Z$area)
```

<center>
![Fig-2:éƒµéå€è™Ÿ](fig/zipcode.png)
</center>


```{r fig.height=2.5, fig.width=7}
par(mfrow=c(1,2),cex=0.7)
table(Z$age, useNA='ifany') %>% barplot(main="Age Groups", las=2)
table(Z$area,useNA='ifany') %>% barplot(main="Areas", las=2)
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Quantile of Variables
sapply(Z[,7:9], quantile, prob=c(.99, .999, .9995))  #åˆ†ä½æ•¸
```

```{r}
# Remove Outliers
Z = subset(Z, qty<=24 & cost<=3800 & price<=4000) 
nrow(Z)  # åŸ817741 å¾Œ817182 
```

##### å½™ç¸½è¨‚å–® Assign Transaction ID
æŠŠæ¯ä¸€å¤©ã€æ¯ä¸€ç‚ºé¡§å®¢çš„äº¤æ˜“é …ç›®å½™ç¸½ç‚ºä¸€å¼µè¨‚å–®
```{r}
Z$tid = group_indices(Z, date, cust) # same customer same day

#group_indices æ˜¯æ ¹æ“šdateå’Œcustçš„é¡åˆ¥ä¾†åˆ†ç¾¤ å°‡å…©å€‹è®Šæ•¸éƒ½ç›¸åŒçš„åˆ†åœ¨åŒä¸€ç¾¤
#é€™é‚Šæ˜¯å¦å¤–åœ¨Zè³‡æ–™é›†æ–°å¢ä¸€å€‹è®Šæ•¸ å°‡å‡½å¼å›å‚³çš„å€¼å­˜åˆ°tid
#å› ç‚ºæ˜¯æ ¹æ“šæ—¥æœŸè·Ÿé¡§å®¢åˆ†ç¾¤ï¼Œæ‰€ä»¥åŒä¸€å€‹é¡§å®¢åŒä¸€å¤©çš„tid æœƒç›¸åŒ
#è·Ÿ group_by ç›¸å ä¸€å€‹indexä¸€å€‹å¯¦éš›çš„åˆ†çµ„
########################################################################

#817182

#å°‡Zè³‡æ–™æ¡†ä¸­ï¼Œæ ¹æ“šå¤©æ•¸(date)è·Ÿé¡§å®¢(cust)å…©å€‹æ¬„ä½ç”¢ç”ŸIndexï¼Œå«åštid(æ¯å€‹çµ„åˆçµ¦ä»–ä¸€å€‹ç·¨è™Ÿ)

```

##### è³‡æ–™ç¸½è¦½
```{r}
# No. cust, cat, prod, tid
sapply(Z[c("cust","cat","prod","tid")], n_distinct)

# n_distinct() è¨ˆç®—æ˜é¡¯ä¸åŒçš„å€‹é«”æ•¸ç›®(è¨ˆç®—åˆ—ä¸­å”¯ä¸€å‡ºç¾çš„æ¬¡æ•¸)
# ä¸€ç­†äº¤æ˜“å¾—åˆ°å¤šå€‹ç”¢å“ <--> é‚£äº›ç”¢å“å…±ç”¨ä¸€ç­†äº¤æ˜“(tid)

```
<br><hr>

### 2. äº¤æ˜“è¨ˆéŒ„ï¼š`X`

##### äº¤æ˜“è³‡æ–™å½™æ•´
```{r}
X = Z %>% group_by(tid) %>% summarise(
  date = min(date),          # äº¤æ˜“æ—¥æœŸ  
  cust = min(cust),          # é¡§å®¢ ID
  age = min(age),            # é¡§å®¢ å¹´é½¡ç´šåˆ¥
  area = min(area),          # é¡§å®¢ å±…ä½å€åˆ¥
  items = n(),               # äº¤æ˜“é …ç›®(ç¸½)æ•¸
  pieces = sum(qty),         # ç”¢å“(ç¸½)ä»¶æ•¸
  total = sum(price),        # äº¤æ˜“(ç¸½)é‡‘é¡
  gross = sum(price - cost)  # æ¯›åˆ©
) %>% data.frame
nrow(X) # 119422 
```

##### è™•ç†é›¢ç¾¤å€¼
```{r}
# Check Quantile & Remove Outliers
sapply(X[,6:9], quantile, prob=c(.999, .9995, .9999))
```

```{r}
# Remove Outliers
X = subset(X, items<=62 & pieces<95 & total<16000) # 119328
```

##### äº¤æ˜“æ‘˜è¦
```{r}
summary(X)    
```

##### æ¯å‘¨äº¤æ˜“æ¬¡æ•¸
```{r fig.height=3, fig.width=7}
par(cex=0.8)
hist(X$date, "weeks", freq=T, las=2, main="No. Transaction per Week")

#ä»¥12æœˆæœ€å¾Œä¸€å€‹ç¦®æ‹œçš„è³‡æ–™ç­†æ•¸æœ€ä½ä¸åˆ°2000ç­†ï¼Œæ¬¡ä½è³‡æ–™ç­†æ•¸æ˜¯2æœˆæœ€å¾Œä¸€å€‹ç¦®æ‹œ

```
<br><hr>

### 3. é¡§å®¢è³‡æ–™ï¼š`A`

##### é¡§å®¢è³‡æ–™å½™æ•´
```{r}
d0 = max(X$date) + 1     #ç¾åœ¨æ—¥æœŸåŠ  1

#ä»¥ä»Šå¤©åŠ 1ç‚ºåŸºæº–çœ‹åŒé¡§å®¢è³¼è²·ç´€éŒ„æœ€å°å¤©æ•¸çš„è·é›¢&æœ€å¤§å¤©æ•¸çš„è·é›¢

A = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
  ) %>% group_by(cust) %>% summarise(
    r = min(days),      # recency   é–“éš”æœ€å°å¤©æ•¸
    s = max(days),      # seniority   æœ€å¤§é–“éš”å¤©æ•¸
    f = n(),            # frquency
    m = mean(total),    # monetary è²¨å¹£ (å¹³å‡èŠ±å¤šå°‘)
    rev = sum(total),   # total revenue contribution ç¸½æ”¶å…¥è²¢ç»
    raw = sum(gross),   # total gross profit contribution ç¸½æ¯›åˆ©è²¢ç»
    age = min(age),     # age group
    area = min(area),   # area code
  ) %>% data.frame      
nrow(A) # 32241

#difftime(time1, time2, tz,units = c(â€œautoâ€, â€œsecsâ€, â€œminsâ€, â€œhoursâ€,â€œdaysâ€, â€œweeksâ€))
#å–®ä½= cï¼ˆâ€œè‡ªå‹•â€ï¼Œâ€œç§’â€ï¼Œâ€œåˆ†é˜â€ï¼Œâ€œå°æ™‚â€ï¼Œâ€œå¤©â€ï¼Œâ€œé€±â€ï¼‰ï¼‰

```

```{r fig.height=2.5, fig.width=7.2}
par(mfrow=c(1,2),cex=0.7)
table(A$age, useNA='ifany') %>% barplot(main="Age Groups",las=2)
table(A$area, useNA='ifany') %>% barplot(main="Areas",las=2)  

# ç¬¬ä¸€å¼µåœ–å¯ä»¥çœ‹å‡ºä¾†è³¼è²·äººæ•¸æœ€å¤šçš„å¹´é½¡æ˜¯åˆ†ä½ˆåœ¨35-39æ­²ä¸­
# ç¬¬äºŒå¼µåœ–å¯ä»¥çœ‹å‡ºä¾†ä½åœ¨å—æ¸¯å€çš„æ¶ˆè²»è€…æ˜¯ä½”æœ€å¤šæ•¸çš„

```

##### é¡§å®¢æ‘˜è¦
```{r}
summary(A) 
```

```{r}
## solution 1

A.segm <- A %>% 
  mutate(frequency = ifelse(between(f, 1, 1), "1",
                       ifelse(between(f, 2, 2), "2", 
                              ifelse(between(f, 3, 4), "3~4", ">4")))) %>%
  
  mutate(recency = ifelse(between(r, 1, 8), "<9 å¤©",
                       ifelse(between(r, 9, 25), "9~25 å¤©", 
                              ifelse(between(r, 26, 59), "26~59 å¤©", ">59 å¤©")))) %>%
  arrange(cust) %>% 
  group_by(frequency, recency) %>%
  summarise(quantity = n()) %>%
  mutate(client = "é¡§å®¢æ•¸é‡") %>%
  ungroup()

A.segm$frequency <- factor(A.segm$frequency, levels = c(">4", "3~4", "2", "1"))
A.segm$recency <- factor(A.segm$recency, levels = c(">59 å¤©", "26~59 å¤©", "9~25 å¤©", "<9 å¤©"))

table(A.segm$recency)  #å¹³å‡åˆ†4çµ„

lcg <- A.segm %>%
  mutate(rec.type = ifelse(recency %in% c(">59 å¤©", "26~59 å¤©"), "not recent", "recent"),
         freq.type = ifelse(frequency %in% c(">4", "3~4"), "frequent", "infrequent"),
         customer.type = interaction(rec.type, freq.type))  #interaction:ç›¸äº’ä½œç”¨


ggplot(lcg, aes(x=client, y=quantity, fill=customer.type)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_rect(aes(fill = customer.type), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.1) +
  facet_grid(frequency ~ recency) +
  geom_bar(stat='identity', alpha=0.7) +                        #yè»¸å¿…éœ€ä½¿ç”¨è‡ªå·±ç®—çš„çµæœ
  geom_text(aes(y=max(quantity)/2, label=quantity), size=4) +
  ggtitle("Rèˆ‡Fåˆ†æåœ–") +
  xlab("æœ€è¿‘ä¸€æ¬¡æ¶ˆè²»å¤©æ•¸") + ylab("è³¼è²·é »ç‡")+ 
  theme(plot.title = element_text(color="red", size=30 ),
        axis.title.x = element_text(color="blue", size=20, face="bold"),
        axis.title.y = element_text(color="#993333", size=20, face="bold"))+
  guides(fill=guide_legend(title="å®¢ç¾¤é¡è‰²æŒ‡ç¤ºè¡¨"))+  
  scale_fill_discrete(name="Experimental\nCondition",breaks = c('not recent.frequent','recent.frequent','not recent.infrequent','recent.infrequent'), labels = c('å…ˆå‰å®¢','å¸¸è²´å®¢','ä¸€æ¬¡æ€§æ¶ˆè²»å®¢äºº','æ–°é¡§å®¢'))

#guides:æŒ‡å—
#scale_fill_discrete:è¨­ç½®é¡è‰²

## solution 2
library(reshape2)

B.segm <- A
B.segm$r <- (B.segm$r - mean(B.segm$r)) / sd(B.segm$r)
B.segm$f <- (B.segm$f - mean(B.segm$f)) / sd(B.segm$f)
B.segm$m <- (B.segm$m - mean(B.segm$m)) / sd(B.segm$m)

B.segm$team <- "0"
B.segm[B.segm$r < 0 & B.segm$f > 0 & B.segm$m < 0, ]$team <- "ä¸€èˆ¬åƒ¹å€¼å®¢æˆ¶"
B.segm[B.segm$r < 0 & B.segm$f < 0 & B.segm$m > 0, ]$team <- "é‡è¦ç™¼å±•å®¢æˆ¶"
B.segm[B.segm$r < 0 & B.segm$f > 0 & B.segm$m > 0, ]$team <- "VIPå®¢æˆ¶"
B.segm[B.segm$r < 0 & B.segm$f < 0 & B.segm$m < 0, ]$team <- "ä¸€èˆ¬ç™¼å±•å®¢æˆ¶"
B.segm[B.segm$r > 0 & B.segm$f > 0 & B.segm$m > 0, ]$team <- "é‡è¦ä¿æŒå®¢æˆ¶"
B.segm[B.segm$r > 0 & B.segm$f < 0 & B.segm$m > 0, ]$team <- "é‡è¦æŒ½ç•™å®¢æˆ¶"
B.segm[B.segm$r > 0 & B.segm$f < 0 & B.segm$m < 0, ]$team <- "æ²‰ç¡å®¢æˆ¶"
B.segm[B.segm$r > 0 & B.segm$f > 0 & B.segm$m < 0, ]$team <- "ä¸€èˆ¬ä¿æŒå®¢æˆ¶"
table(B.segm$team)

df <- melt(B.segm[c("r", "f", "m", "team")], id = "team")

ggplot(df, aes(x = variable, y = value, group = team, fill = variable)) +
  stat_summary(fun.y=mean, geom="bar",position=position_dodge(1)) +
  facet_grid(~team) +
  labs(y = "å¹³å‡/æ¨™æº–å·®", fill="RFM", x = " ") +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5),
        text = element_text(size = 8))
```

```{r}

d0 = max(X$date) + 1     #ç¾åœ¨æ—¥æœŸåŠ  1

#ä»¥ä»Šå¤©åŠ 1ç‚ºåŸºæº–çœ‹åŒé¡§å®¢è³¼è²·ç´€éŒ„æœ€å°å¤©æ•¸çš„è·é›¢&æœ€å¤§å¤©æ•¸çš„è·é›¢

salesRFM = X %>% mutate(
  days = as.integer(difftime(d0, date, units="days"))
) %>% group_by(cust) %>% summarise(
  Recency = min(days),      # recency   é–“éš”æœ€å°å¤©æ•¸
  s = max(days),      # seniority   æœ€å¤§é–“éš”å¤©æ•¸
  Frequency = n(),            # frquency
  m = mean(total),    # monetary è²¨å¹£ (å¹³å‡èŠ±å¤šå°‘)
  Monetary = sum(total),   # total revenue contribution ç¸½æ”¶å…¥è²¢ç»
  raw = sum(gross),   # total gross profit contribution ç¸½æ¯›åˆ©è²¢ç»
  age = min(age),     # age group
  area = min(area),   # area code
) %>% data.frame      

```


```{r}
###############################################################################
###############################################################################
###############################################################################

#R_S:åŸºæ–¼æœ€è¿‘ä¸€æ¬¡äº¤æ˜“æ—¥æœŸè¨ˆç®—å¾—åˆ†ï¼Œè·é›¢ç•¶å‰æ—¥æœŸè¶Šè¿‘ï¼Œå‰‡å¾—åˆ†è¶Šé«˜ï¼Œå¦å‰‡å¾—åˆ†è¶Šä½ï¼›
#F_S:åŸºæ–¼äº¤æ˜“é »ç‡è¨ˆç®—å¾—åˆ†ï¼Œäº¤æ˜“é »ç‡è¶Šé«˜ï¼Œå‰‡å¾—åˆ†è¶Šé«˜ï¼Œå¦å‰‡å¾—åˆ†è¶Šä½ï¼›
#M_Sï¼šåŸºæ–¼äº¤æ˜“é‡‘é¡å¾—åˆ†ï¼Œäº¤æ˜“é‡‘é¡è¶Šé«˜ï¼Œå‰‡å¾—åˆ†è¶Šé«˜ï¼Œåä¹‹å¾—åˆ†è¶Šä½ã€‚
#åŒæ™‚ç‚ºäº†å°æ¯å€‹å®¢æˆ¶é€²è¡Œç¶œåˆè©•åƒ¹ï¼Œ
#ä¹Ÿå¯å°‡ä»¥ä¸Šä¸‰å€‹å¾—åˆ†é€²è¡ŒåŠ æ¬Šè¨ˆç®—
#é€™è£¡çµ±ä¸€æ¡ç”¨100:10:1
#RFM = 100 R_S + 10 F_S + 1*M_S


#è¨ˆç®—å¾—åˆ†
salesRFM <-mutate(salesRFM,
                   rankR = 6-cut(salesRFM$Recency,
                               breaks=quantile(salesRFM$Recency,
                                               probs=seq(0,1,0.2),
                                               names = FALSE),
                               include.lowest = TRUE,labels=F),   
                  #åˆ†æ•¸é«˜é–“éš”çŸ­ : 1~5åˆ†
                  
                   rankF = cut(salesRFM$Frequency ,
                               breaks = c(1,2,3,4,5,85),
#quantile(salesRFM$Frequency,probs=seq(0, 1, 0.2),names = FALSE),# 1 1 2 3 5 85
                               include.lowest = TRUE,labels=F), 
                  #åˆ†æ•¸é«˜é »ç‡é«˜ : 1~5åˆ†

                   rankM = cut(salesRFM$Monetary,
                               breaks = quantile(salesRFM$Monetary,
                                                 probs = seq(0, 1, 0.2),
                                                 names = FALSE),
                               include.lowest = TRUE,labels=F),
                  #åˆ†æ•¸é«˜è²·çš„ç¸½é¡é«˜ : 1~5åˆ†

                   rankRMF = 100*rankR + 10*rankF + 1*rankM)
                  #åŠ æ¬Š(çœ‹æˆ‘å€‘åœ¨æ„çš„é»)

salesRFM <-mutate(salesRFM, 
                  rankR1 = 1-rescale(salesRFM$Recency,to = c(0,1)),  
                  rankF1 = rescale(salesRFM$Frequency,to = c(0,1)),  
                  rankM1 = rescale(salesRFM$Monetary,to = c(0,1)),  
                  rankRMF1 = 0.5*rankR + 0.3*rankF + 0.2*rankM)
                  #æŠŠåˆ†æ•¸æ­£è¦åŒ–ï¼Œè·Ÿä¸Šé¢çµæœå·®ä¸å¤š


#å®¢æˆ¶åˆ†é¡
salesRFM <- within(salesRFM,
                   {R_S = ifelse(rankR > mean(rankR),2,1)     #åˆ†æ•¸è¶Šé«˜è¶Šå¥½
                    F_S = ifelse(rankF > mean(rankF),2,1)  
                    M_S = ifelse(rankM > mean(rankM),2,1)})

salesRFM <- within(salesRFM,{Custom = NA  
Custom[R_S == 2 & F_S == 2 & M_S == 2] = 'é«˜åƒ¹å€¼å®¢æˆ¶'  
Custom[R_S == 1 & F_S == 2 & M_S == 2] = 'é‡é»ä¿æŒå®¢æˆ¶'  
Custom[R_S == 2 & F_S == 1 & M_S == 2] = 'é‡é»ç™¼å±•å®¢æˆ¶'    
Custom[R_S == 1 & F_S == 1 & M_S == 2] = 'é‡é»æŒ½ç•™å®¢æˆ¶'  
Custom[R_S == 2 & F_S == 2 & M_S == 1] = 'é‡é»ä¿è­·å®¢æˆ¶'  
Custom[R_S == 1 & F_S == 2 & M_S == 1] = 'ä¸€èˆ¬ä¿è­·å®¢æˆ¶'  
Custom[R_S == 2 & F_S == 1 & M_S == 1] = 'ä¸€èˆ¬ç™¼å±•å®¢æˆ¶'  
Custom[R_S == 1 & F_S == 1 & M_S == 1] = 'æ½›åœ¨å®¢æˆ¶'
})                                                            #åˆ†å‡ºå®¢ç¾¤

```

```{r}
#åˆ†æçµæœå¯è¦–åŒ–
ggplot(salesRFM,aes(rankM,fill=Custom))+
  ggtitle("RMFåˆ†æåœ–(åˆ†æ•¸è¡¨)")+
  geom_bar()+                               #åœ¨20%å€é–“çš„äººæ•¸(2000~0)
  facet_grid(rankF~rankR)+
  xlab("æœ€è¿‘ä¸€æ¬¡æ¶ˆè²»å¤©æ•¸(5:top20%~1:80-100%)") + ylab("è³¼è²·é »ç‡(5:top20%~1:80-100%)")+
  theme_bw()
```

```{r}

#é«˜åƒ¹å€¼å®¢æˆ¶(æ¶ˆè²»é‡‘é¡é«˜)(TOP 1-60)  
#é‡é»ä¿è­·å®¢æˆ¶(æ¶ˆè²»é‡‘é¡ä½)(TOP 60-100)
#-->å¸¸è²´å®¢

# Create the mode function.
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

r2f2m2 = filter(salesRFM,salesRFM$Custom =='é«˜åƒ¹å€¼å®¢æˆ¶')
bind_r2f2m2 = subset(Z, Z$cust %in% r2f2m2$cust) 
sapply(bind_r2f2m2[c("age","cat","prod",'area')], getmode) #"a39" "100205" "4714981010038" "z115"

table(bind_r2f2m2$age,bind_r2f2m2$area)
group_by(bind_r2f2m2,bind_r2f2m2$cust) %>% arrange(desc(price))
heatmap(table(bind_r2f2m2$age,bind_r2f2m2$area))
mosaic(~age+area, data=group_by(bind_r2f2m2,bind_r2f2m2$cust), shade=T)




r2f2m1 = filter(salesRFM,salesRFM$Custom =='é‡é»ä¿è­·å®¢æˆ¶')
bind_r2f2m1 = subset(Z, Z$cust %in% r2f2m1$cust) 
sapply(bind_r2f2m1[c("age","cat","prod",'area')], getmode) #"a34" "130315" "4714981010038" "z115" 

table(bind_r2f2m1$age,bind_r2f2m1$area)
group_by(bind_r2f2m1,bind_r2f2m1$cust) %>% arrange(desc(price))
heatmap(table(bind_r2f2m1$age,bind_r2f2m1$area))
mosaic(~age+area, data=group_by(bind_r2f2m1,bind_r2f2m1$cust), shade=T)






#é‡é»ç™¼å±•å®¢æˆ¶(æ¶ˆè²»é‡‘é¡é«˜)
#ä¸€èˆ¬ç™¼å±•å®¢æˆ¶(æ¶ˆè²»é‡‘é¡ä½)
#-->æ–°é¡§å®¢

r2f1m2 = filter(salesRFM,salesRFM$Custom =='é‡é»ç™¼å±•å®¢æˆ¶')
bind_r2f1m2 = subset(Z, Z$cust %in% r2f1m2$cust) 
sapply(bind_r2f1m2[c("age","cat","prod",'area')], getmode) #"a39" "100205" "4714981010038" "z221"

table(bind_r2f1m2$age,bind_r2f1m2$area)
group_by(bind_r2f1m2,bind_r2f1m2$cust) %>% arrange(desc(price))
heatmap(table(bind_r2f1m2$age,bind_r2f1m2$area))
mosaic(~age+area, data=group_by(bind_r2f1m2,bind_r2f1m2$cust), shade=T)




r2f1m1 = filter(salesRFM,salesRFM$Custom =='ä¸€èˆ¬ç™¼å±•å®¢æˆ¶')
bind_r2f1m1 = subset(Z, Z$cust %in% r2f1m1$cust) 
sapply(bind_r2f1m1[c("age","cat","prod",'area')], getmode) #"a39" "130315" "4714981010038" "z115" 

table(bind_r2f1m1$age,bind_r2f1m1$area)
group_by(bind_r2f1m1,bind_r2f1m1$cust) %>% arrange(desc(price))
heatmap(table(bind_r2f1m1$age,bind_r2f1m1$area))
mosaic(~age+area, data=group_by(bind_r2f1m1,bind_r2f1m1$cust), shade=T)


#è€ƒæ…®åˆ©æ½¤?






```

```{r fig.height=8}
par(mfrow=c(3,2), mar=c(3,3,4,2))

for(x in c('r','s','f','m')) 
  hist(A[,x],20,freq=T,main=x,xlab="",ylab="",cex.main=2)

hist(pmin(A$f,10),0:10,freq=T,xlab="",ylab="",cex.main=2,main="frequency")
# è·Ÿ10æ¯”å–å°ï¼›xè»¸ç¯„åœ0åˆ°10
hist(log(A$m,10),freq=T,xlab="",ylab="",cex.main=2,main="log(money)")

# cex.axis â€“ ä½¿ç”¨é•·åº¦ç‚º 1 çš„æ•¸å€¼æŒ‡å®šåˆ»åº¦æ¨™ç±¤æ•¸å­—/æ–‡æœ¬çš„å¤§å°ã€‚
# cex.lab â€“ ä½¿ç”¨é•·åº¦ç‚º 1 çš„æ•¸å€¼æŒ‡å®šè»¸æ¨™ç±¤æ–‡æœ¬çš„å¤§å°ã€‚
# cex.main â€“ ä½¿ç”¨é•·åº¦ç‚º 1 çš„æ•¸å€¼æŒ‡å®šæ¨™é¡Œæ–‡æœ¬çš„å¤§å°ã€‚
# cex.sub â€“ ä½¿ç”¨é•·åº¦ç‚º 1 çš„æ•¸å€¼æŒ‡å®šå­—å¹•æ¨™ç±¤çš„å¤§å°

# råœ–ï¼šå¤§å¤šæ•¸äººæœ€è¿‘çš„ä¸€ç­†è¨‚å–®æ˜¯åœ¨0-10å¤©å‰ç™¼ç”Ÿ
# såœ–ï¼šå¤§å¤šæ•¸äººçš„ç¬¬ä¸€ç­†è¨‚å–®æ˜¯åœ¨è·ä»Š100å¤©åˆ°å››å€‹æœˆå‰
# fåœ–ï¼šè³¼è²·æ¬¡æ•¸çš„åˆ†å¸ƒåœ–ï¼Œå¯ä»¥çœ‹å‡ºçµ•å¤§å¤šæ•¸çš„å®¢äººåªæœ‰è³¼è²·0-5æ¬¡
# måœ–ï¼šè³¼è²·ç¸½é¡åˆ†å¸ƒåœ–ï¼Œè³¼è²·ç¸½é‡‘é¡æœ€å¤šåˆ†å¸ƒåœ¨0-1000å…ƒ
# plimåœ–ï¼šä¸€æ¨£æ˜¯è³¼è²·æ¬¡æ•¸åˆ†å¸ƒåœ–ï¼Œåªæ˜¯ä¸Šé™è¨­åœ¨10æ¬¡ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°åœ¨è³¼è²·0-10æ¬¡ä¸­å¤§å¤šæ•¸çš„äººå°±åªæœ‰è²·ä¸€æ¬¡
# logåœ–ï¼šå°è³¼è²·ç¸½é‡‘é¡å–å°æ•¸éå¾Œçš„åˆ†å¸ƒåœ–

```

ğŸŒ· **åæ…‹åˆ†ä½ˆçš„è™•ç†æ–¹æ³•**

+ å°æ•¸è½‰æ› - `log(A$m, 10)`
+ å›ºå®šä¸Šé™ - `pmin(A$f, 10)`

<br> 

##### Check & Save
```{r}
is.na(Z) %>% colSums
```

```{r}
is.na(X) %>% colSums
```

```{r}
is.na(A) %>% colSums
```

```{r}
A0 = A; X0 = X; Z0 = Z
save(Z0, X0, A0, file="data/tf0.rdata")
```

<br><hr>

### 4. è¡ŒéŠ·ä¼ç•«ç«¶è³½ 

##### A.ä¼ç•«é …ç›®

+ 1)åˆ©ç”¨æ—¢æœ‰å’Œè¡ç”Ÿçš„è®Šæ•¸åšé¡§å®¢åˆ†ç¾¤(æ¨™ç±¤)
+ 2)æ ¹æ“šé¡§å®¢æ—ç¾¤åƒ¹å€¼å±¬æ€§ï¼Œé¸å–è¡ŒéŠ·é‡é»ã€è¨­å®šè¡ŒéŠ·ç›®æ¨™
+ 3)è£½ä½œæ¨¡å‹ï¼šä¼°è¨ˆæ¯ä¸€ä½é¡§å®¢çš„ï¼š
    + å›è³¼æ©Ÿç‡
    + é æœŸç‡Ÿæ”¶ã€é æœŸç²åˆ©
    + çµ‚ç”Ÿåƒ¹å€¼
+ 4)æ ¹æ“šé¡§å®¢æ—ç¾¤ç‰¹å¾µï¼Œè¨­è¨ˆ(è‡³å°‘å…©é …)è¡ŒéŠ·æ–¹æ¡ˆ
+ 5)å°æ–¹æ¡ˆçš„æˆæœ¬ã€æ•ˆç›Šé€²è¡Œ(å¯ä»¥é€éåƒæ•¸èª¿æ•´çš„)å‡è¨­
+ 6)è¨­è¨ˆæ¨¡æ“¬ç¨‹å¼ï¼Œè—‰ä»¥ï¼š 
    + é¸æ“‡è¡ŒéŠ·æ–¹æ¡ˆ
    + è¨­å®šæ–¹æ¡ˆåƒæ•¸
    + é¸æ“‡è¡ŒéŠ·å°è±¡
    + ä¼°è¨ˆæˆæœ¬æ•ˆç›Š
+ 7)åšä¸€å€‹å®Œæ•´çš„è¡ŒéŠ·ä¼åŠƒå ±å‘Šï¼š
    + ç¶“ç‡Ÿç¾æ³
    + æ”¹å–„ç­–ç•¥
    + è¡ŒéŠ·æ–¹æ¡ˆ
    + é æœŸæˆæ•ˆ

##### B.è©•åˆ†é …ç›®

1) èƒ½å¾è³‡æ–™ä¸­æ‰¾å‡ºé‡è¦çš„ç¾è±¡ã€çµæ§‹ã€è¶¨å‹¢
2) èƒ½å–„ç”¨è³‡æ–™è¦–è¦ºåŒ–å‘ˆç¾é‡è¦ç™¼ç¾
3) èƒ½æ‰¾å‡ºç‰¹æ®Šçš„ã€æœ‰åƒ¹å€¼çš„é¡§å®¢æ—ç¾¤
4) èƒ½æ‰¾åˆ°æˆ–å°å‡ºæœ‰é æ¸¬åŠ›çš„è®Šæ•¸
5) èƒ½æ ¹æ“šåˆ†æçš„çµæœé¸æ“‡ç­–ç•¥é‡é»ã€è¨­å®šç­–ç•¥(é‡åŒ–)ç›®æ¨™
6) èƒ½æå‡ºæœ‰æ•ˆã€æœ‰å‰µæ„çš„è¡ŒéŠ·æ–¹æ¡ˆ
7) èƒ½è¨­è¨ˆå‡ºåˆç†çš„å‡è¨­
8) èƒ½æ­£ç¢ºæ¼”ç·´å¸‚å ´æ¨¡æ“¬çš„ç¨‹åºï¼Œæ¸…æ¥šè¡¨é”ç­–ç•¥è¦åŠƒçš„é‚è¼¯
9) æ•´ä»½è¡ŒéŠ·ä¼åŠƒçš„æ•´é«”(å½±ç‰‡+æ–‡æ¡ˆ)å“è³ª
10) æŠ•å…¥è³‡æºåŸ·è¡Œé€™ä¸€ä»½ä¼åŠƒçš„æ„é¡˜

<br><hr>

### 5. è³‡æ–™æ¢ç´¢ç·´ç¿’

+ 1)ä¸åŒçš„å¹´é½¡(æˆ–åœ°ç†)æ—ç¾¤çš„è³¼è²·è¡Œç‚ºæœ‰ä»€éº¼å·®ç•°
+ 2)é¡§å®¢åœ¨å‘¨æœ«å’Œå‘¨é–“çš„è³¼è²·è¡Œç‚ºæ˜¯ä¸€æ¨£çš„å—
+ 3)è³£çš„æœ€å¥½çš„å“é¡(å“é …) 
+ 4)éŠ·å”®é‡æˆ–ç‡Ÿæ”¶æœ€å¤§çš„å“é¡(å“é …)ç²åˆ©ä¹Ÿæ˜¯æœ€å¤§çš„å—
+ 5)ä¾æ“š ... åšé¡§å®¢åˆ†ç¾¤(å¸‚å ´å€éš”)
    + RFM
    + å¹´é½¡å±¤ã€å±…ä½åœ°å€
    + æ›¾è³¼è²·çš„ç”¢å“
    + ...
+ 6)æ¯”è¼ƒå„æ—ç¾¤çš„ç‰¹å¾µ
+ 7)...
+ 8)è¨­å®šè¡ŒéŠ·ç›®æ¨™å’Œç­–ç•¥ 

##### é¡åˆ¥è³‡æ–™çš„åˆ†é¡çµ±è¨ˆ
```{r fig.height=6, fig.width=7.5}
mosaic(~area+age, data=A, shade=T)
```

<br><br><br><br>